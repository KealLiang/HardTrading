# A股涨停复盘梯队形态图实现方案

## 一、背景与需求

用户目前拥有一个基于 `whimsical.py` 生成的A股每日涨停个股复盘数据Excel。该Excel的特点是：

*   每日涨停个股按天罗列。
*   通过不同的背景颜色区分个股所属的题材概念。
*   包含日期、指数情况、概念图例等辅助信息。
*   涨停个股单元格内容为 `"{个股名称}{连板天数}"`。
*   黑色单元格用于分隔连板股和首板股。

用户认为当前形式的复盘数据查看起来较为混乱，期望能将其改造成一种更直观的**梯队形态的涨停走势图**。
为了不被大量数据淹没，需限制处理的范围，每日关注的个股应该是**连板涨停**的，下文中提到的【涨停股】均认为是连板涨停股（即黑色单元格上方的）。

**核心需求：**

1.  **梯队展示**：每日涨停股能清晰地呈现出阶梯状向右下方延伸的形态，直观反映市场龙头和梯队情况。
2.  **断板跟踪**：对于之前涨停（尤其是连板）的个股，在它们断板（不再涨停）后，能够在后续的日期中横向继续显示其每日的涨跌幅百分比。
3.  **概念整合**：个股的题材概念信息从单元格颜色区分转变为直接显示在第一列的股票名称之前，例如 `[AI] 龙头股份`。
4.  **颜色用途调整**：单元格的背景颜色主要用于表示个股的涨跌幅（红涨绿跌，不同幅度颜色深浅不同），涨停的单元格也应有特殊标记（可能通过特定颜色或标记）。
5.  **参考样式**：用户提供了一张网络截图（截图2），大致展示了期望的最终效果。

**数据基础：**

*   **连板与概念数据**：通过 `whimsical.py` 处理 `fupan_stocks.xlsx` 得到，包含每日涨停股、连板天数、涨停原因等。
*   **个股日线数据**：通过 `astock_data.py` 使用 `akshare` 拉取并存储在本地CSV文件，包含每只A股的开盘、收盘、涨跌幅等日线行情。

## 二、实现思路与步骤

### 阶段一：数据提取与预处理

1.  **确定分析周期**:
    *   沿用 `whimsical.py` 中的 `start_date` 和 `end_date` (例如 `'20240101'` 到 `'20240601'`)。
    *   使用 `utils.date_util.get_trading_days` 获取此周期内的所有交易日列表 `trading_days` (格式为 `YYYYMMDD`)。

2.  **加载和处理涨停数据**:
    *   **复用 `whimsical.py` 的逻辑**:
        *   调用或参照 `process_zt_data` 函数的核心数据处理部分，以获取分析周期内每一天的 `daily_stocks` 数据。`daily_stocks` 是一个字典，键为日期字符串 (如 `'2024年05月20日'`)，值为当日所有涨停股票的信息列表。每个股票信息是一个字典，包含 `code`, `name`, `info` (内含 `'涨停原因类别'`, `'几天几板'`), `board_level` (连板数)。
        *   确保 `stock_reason_group` (股票代码和名称到主要概念的映射) 也被正确生成。
    *   **数据转换**: 注意统一日期格式。

3.  **构建个股行情数据获取器**:
    *   创建一个辅助函数，例如 `get_stock_daily_pct_change(stock_code, date_str_yyyymmdd, stock_name, save_path='./stock_data')`:
        *   输入股票代码、目标日期 (`YYYYMMDD`)、股票名称和数据存储路径。
        *   根据输入定位对应的本地CSV行情文件。
        *   读取文件，找到目标日期行，提取 `涨跌幅`。
        *   返回涨跌幅。对停牌或数据缺失情况做处理。
    *   考虑缓存已读取的CSV数据以提高效率。

4.  **收集所有分析周期内涨停过的股票信息**:
    *   遍历 `trading_days` 和对应的 `daily_stocks`。
    *   创建一个列表 `all_unique_漲停_stocks`，存储所有在分析周期内至少涨停过一次的股票。
    *   记录：`code`, `name`, `first_zt_date_yyyymmdd` (本周期内首次涨停日), `main_concept`。
    *   去重。

### 阶段二：构建梯队数据结构

1.  **确定股票在Excel中的行顺序**:
    *   对 `all_unique_漲停_stocks` 列表进行排序。
        *   主要依据：`first_zt_date_yyyymmdd` (升序)。
        *   次要依据：当日 `board_level` (降序) 或股票代码 (升序)。

2.  **初始化梯队数据表 (例如使用Pandas DataFrame)**:
    *   行索引 (Index)：根据排序后的股票生成，格式为 `f"[{main_concept}] {name}"`。
    *   列索引 (Columns)：分析周期内的所有交易日 `trading_days` (格式化为 `YYYY-MM-DD` 或 `MM-DD`)。
    *   初始填充为 `NaN` 或空字符串。

3.  **填充梯队数据表**:
    *   遍历 `trading_days` (作为列 `current_col_date_yyyymmdd`)。
    *   对于每个交易日，再遍历 `all_unique_漲停_stocks` (作为行 `s`)。
        *   获取 `s` 的 `code`, `name`, `concept`，确定其在DataFrame中的行标签和列标签。
        *   **填充逻辑**:
            *   若 `current_col_date_yyyymmdd` 早于 `s.first_zt_date_yyyymmdd`，单元格为空。
            *   否则：
                *   检查 `s` 是否在当日涨停列表 (`daily_stocks` 中对应日期的数据) 中：
                    *   **是 (当日涨停)**: 获取当日 `board_level` (Y)。单元格填入 `f"{s_name}{Y}"` 或仅 `s_name`。记录为“涨停”状态。
                    *   **否 (当日未涨停/断板)**: 调用 `get_stock_daily_pct_change` 获取当日涨跌幅 `pct_chg`。单元格填入 `f"{pct_chg:.2f}%"` 或 "停牌"等。记录为“非涨停/涨跌幅”状态。

### 阶段三：Excel 输出

1.  **创建 Excel 工作簿和工作表** (使用 `openpyxl`)。

2.  **写入列标题 (日期)**。

3.  **写入行标题 (股票信息 `[{概念}] 名称`)**。

4.  **写入数据区域并设置格式**:
    *   遍历DataFrame，将值写入Excel。
    *   **单元格背景色**:
        *   “涨停”状态: 根据 `board_level` 或统一规则设置特定颜色（如红色系，板数越高颜色越深）。
        *   “非涨停/涨跌幅”状态: 根据涨跌幅数值，使用调整后的 `get_color_by_pct_change` 函数设置红绿色阶。
        *   空单元格/停牌: 浅灰色或无色。
    *   **字体颜色**: 确保与背景色对比清晰。
    *   **对齐**: 居中。
    *   **边框**: 添加细边框。

5.  **整体格式化**:
    *   调整列宽、行高。
    *   冻结首行和首列。
    *   (可选) 添加VBA宏实现悬停高亮。

6.  **保存 Excel 文件**。

## 四、关键函数和模块的复用与修改点

*   **`whimsical.py`**:
    *   `get_trading_days`, `normalize_reason`, `extract_reasons`: 复用。
    *   `process_zt_data` 核心逻辑: 复用或重构以获取 `daily_stocks` 和 `stock_reason_group`。
    *   `get_color_by_pct_change`: 复用，但颜色和阈值需调整以匹配新需求。
*   **`astock_data.py`**:
    *   主要是被动读取其生成的个股日线CSV数据。
    *   注意股票名称在保存和读取时的一致性（如 `*ST` 处理）。

## 五、注意事项与挑战

1.  **数据一致性**: 股票代码和名称在各环节的准确匹配。
2.  **性能**: 优化文件读取，考虑数据缓存。
3.  **数据空缺**: 处理股票未上市、退市、停牌等情况。
4.  **梯队细节**: 明确涨停单元格内显示内容（仅名称，还是名称+板数），板数如何通过颜色体现。
5.  **断板后跟踪天数**: 目前设计是跟踪到分析周期结束。
6.  **颜色映射规则**: 详细定义涨停板数与颜色、涨跌幅与颜色的对应关系。

这个方案提供了一个实现用户需求的详细框架，具体实施中可能需要根据细节进行调整和迭代。
