# A股涨停复盘梯队形态图实现方案

## 一、背景与需求

用户目前拥有一个基于 `whimsical.py` 生成的A股每日涨停个股复盘数据Excel。该Excel的特点是：

*   每日涨停个股按天罗列。
*   通过不同的背景颜色区分个股所属的题材概念。
*   包含日期、指数情况、概念图例等辅助信息。
*   涨停个股单元格内容为 `"{个股名称}{连板天数}"`。
*   黑色单元格用于分隔连板股和首板股。

用户认为当前形式的复盘数据查看起来较为混乱，期望能将其改造成一种更直观的**梯队形态的涨停走势图**。
> 为了不被大量数据淹没，需限制处理的范围，每日关注的个股应该是**连板涨停**的，下文中提到的【涨停股】均认为是连板涨停股（即黑色单元格上方的）。
> 实际处理时，数据源可以直接使用`fupan_stocks.xlsx`中的sheet[连板数据]，其数据结构可以从保存它的代码中获知。

**核心需求：**

1.  **梯队展示**：每日涨停股能清晰地呈现出阶梯状向右下方延伸的形态，直观反映市场龙头和梯队情况。
2.  **断板跟踪**：对于之前涨停（尤其是连板）的个股，在它们断板（不再涨停）后，能够在后续的日期中横向继续显示其每日的涨跌幅百分比。
3.  **概念整合**：个股的题材概念信息从单元格颜色区分转变为直接显示在第一列的股票名称之前，例如 `[AI] 龙头股份`。
4.  **颜色用途调整**：单元格的背景颜色主要用于表示个股的涨跌幅（红涨绿跌，不同幅度颜色深浅不同），涨停的单元格也应有特殊标记（可能通过特定颜色或标记）。
5.  **参考样式**：用户提供了一张网络截图（截图2），大致展示了期望的最终效果。

**数据基础：**

*   **连板与概念数据**：通过 `whimsical.py` 处理 `fupan_stocks.xlsx` 得到，包含每日涨停股、连板天数、涨停原因等。
*   **个股日线数据**：通过 `astock_data.py` 使用 `akshare` 拉取并存储在本地CSV文件，包含每只A股的开盘、收盘、涨跌幅等日线行情。

## 二、实现思路与步骤

### 阶段一：数据提取与预处理

1.  **确定分析周期**:
    *   沿用 `whimsical.py` 中的 `start_date` 和 `end_date` (例如 `'20240101'` 到 `'20240601'`)。
    *   使用 `utils.date_util.get_trading_days` 获取此周期内的所有交易日列表 `trading_days` (格式为 `YYYYMMDD`)。

2.  **加载和处理涨停数据**:
    *   **复用 `whimsical.py` 的逻辑**:
        *   调用或参照 `process_zt_data` 函数的核心数据处理部分，以获取分析周期内每一天的 `daily_stocks` 数据。`daily_stocks` 是一个字典，键为日期字符串 (如 `'2024年05月20日'`)，值为当日所有涨停股票的信息列表。每个股票信息是一个字典，包含 `code`, `name`, `info` (内含 `'涨停原因类别'`, `'几天几板'`), `board_level` (连板数)。
        *   确保 `stock_reason_group` (股票代码和名称到主要概念的映射) 也被正确生成。
    *   **数据转换**: 注意统一日期格式。

3.  **构建个股行情数据获取器**:
    *   创建一个辅助函数，例如 `get_stock_daily_pct_change(stock_code, date_str_yyyymmdd, stock_name, save_path='./stock_data')`:
        *   输入股票代码、目标日期 (`YYYYMMDD`)、股票名称和数据存储路径。
        *   根据输入定位对应的本地CSV行情文件。
        *   读取文件，找到目标日期行，提取 `涨跌幅`。
        *   返回涨跌幅。对停牌或数据缺失情况做处理。
    *   考虑缓存已读取的CSV数据以提高效率。

4.  **收集所有分析周期内涨停过的股票信息**:
    *   遍历 `trading_days` 和对应的 `daily_stocks`。
    *   创建一个列表 `all_unique_漲停_stocks`，存储所有在分析周期内至少涨停过一次的股票。
    *   记录：`code`, `name`, `first_zt_date_yyyymmdd` (本周期内首次涨停日), `main_concept`。
    *   去重。

### 阶段二：构建梯队数据结构

1.  **确定股票在Excel中的行顺序**:
    *   筛选标准：主要关注在分析周期内有过显著连板表现的股票（例如，至少达到过2连板或以上，具体阈值可配置）。
    *   对符合筛选条件的股票列表进行排序：
        *   主要依据：首次达到显著连板的日期 (`first_significant_board_date`)，升序排列（越早出现的越靠前）。
        *   次要依据：在该首次显著连板日的实际连板天数 (`board_level_at_first_significant`)，降序排列（板数越高的越靠前）。
        *   最终依据：股票代码，升序排列。
    *   每一只符合条件且排序后的股票，将在最终的Excel表格中占据独立的一行。

2.  **定义Excel表格结构**:
    *   **工作表名称**: 例如 `涨停梯队图-YYYYMM`。
    *   **表头信息 (第1-2行)**:
        *   第1行: 通常包含日期和大盘指数涨跌幅等概览信息 (参考截图2的顶部)。
        *   第2行: 日期对应的星期 (例如 `星期一`, `星期二`)。
    *   **数据区域**:
        *   **列A (第一列)**: **题材概念**。显示该行股票最核心或首次连板时的题材概念，例如 `[AI算力]`。
        *   **列B (第二列)**: **股票简称**。显示该行股票的简称，例如 `工业富联`。
        *   **列C, D, E, ... (后续列)**: 按时间顺序排列的**交易日**。每个交易日占据一列。列头显示格式化后的日期 `YYYY-MM-DD` 或 `MM-DD`。

3.  **初始化梯队数据表 (可使用Pandas DataFrame作为中间结构)**:
    *   **行索引 (Rows)**: 由筛选并排序后的股票唯一标识构成 (例如：股票代码)。
    *   **列索引 (Columns)**:
        *   固定列：`concept` (题材概念), `stock_name` (股票简称)。
        *   日期列：分析周期内的所有交易日 `trading_days` (格式化为 `YYYY-MM-DD` 或 `MM-DD`)。
    *   初始时，所有日期单元格可以填充为特殊标记 (如 `NaN`) 或空字符串，表示数据待填充。

4.  **填充梯队数据表内容 (针对每个股票的每一天)**:
    *   遍历每一个筛选出的股票 `s` (作为Excel中的行)。
    *   对于股票 `s`，再遍历分析周期内的每一个交易日 `current_col_date_yyyymmdd` (作为Excel中的列)。
    *   **填充逻辑**:
        *   **单元格A (概念列)**: 填入股票 `s` 的核心题材概念。
        *   **单元格B (股票简称列)**: 填入股票 `s` 的股票简称。
        *   **日期单元格 (C, D, E, ...)**:
            *   若 `current_col_date_yyyymmdd` 早于股票 `s` 首次被关注的日期 (例如，首次2板日)，则该单元格通常为空，或显示一个非常浅的背景色表示尚未出现。
            *   否则，获取股票 `s` 在 `current_col_date_yyyymmdd` 的市场表现：
                *   **情况一：当日涨停 (且为连板关注期内)**
                    *   获取当日的连板天数 `Y` (例如，从 `daily_stocks` 中查询)。
                    *   单元格内容显示为 `Y板` (例如 `2板`, `3板`, `5板`)。参考截图中可能还包含 `晋级`, `炸板` 等更细致的描述，这需要源数据支持。
                    *   记录状态为"涨停"。
                *   **情况二：当日未涨停 (之前曾连板，现已断板或非涨停)**
                    *   调用 `get_stock_daily_pct_change` 获取当日的实际涨跌幅 `pct_chg`。
                    *   单元格内容显示为格式化的百分比，例如 `+5.8%`, `-2.1%`。
                    *   如果当日停牌，显示"停牌"。
                    *   记录状态为"非涨停/涨跌幅"。
                *   **情况三：其他** (例如，股票尚未上市、数据缺失等)
                    *   单元格内容显示为"未上市"、"数据缺失"或保持为空。

### 阶段三：Excel 输出

1.  **创建 Excel 工作簿和工作表** (使用 `openpyxl`)。

2.  **写入表头信息**:
    *   写入日期行和大盘指数行 (如果需要)。
    *   写入星期行。

3.  **写入数据区域**:
    *   遍历预处理好的梯队数据表 (例如 Pandas DataFrame)。
    *   **写入题材概念列 (列A)**。
    *   **写入股票简称列 (列B)**。
    *   **写入每日行情数据 (列C及之后)**:
        *   根据之前填充逻辑获取单元格应显示的内容 (`Y板`, `涨跌幅%`, `停牌` 等)。
        *   将内容写入对应的Excel单元格。

4.  **设置单元格格式**:
    *   **单元格背景色**:
        *   **"涨停"状态**:
            *   根据连板天数 `Y` 设置不同的颜色。例如，板数越高，红色越深或采用特定主题色 (参考截图2中不同板数的颜色)。
            *   可以定义一个颜色映射字典，如 `BOARD_COLORS = {2: "浅红", 3: "中红", 4: "深红", ...}`。
        *   **"非涨停/涨跌幅"状态**:
            *   根据涨跌幅 `pct_chg` 的正负和大小，使用红绿色阶。红色代表上涨，绿色代表下跌。涨/跌幅越大，颜色越深。
            *   复用或调整 `get_color_by_pct_change` 函数。
        *   **"停牌"或"数据缺失"状态**: 可以使用统一的浅灰色背景。
        *   **空单元格 (股票尚未出现或已不跟踪)**: 可以无背景色或使用非常浅的灰色。
    *   **字体颜色**:
        *   确保与背景色形成清晰对比。例如，深色背景搭配浅色字体 (如白色)，浅色背景搭配深色字体 (如黑色)。
        *   对于涨停板数，字体可以加粗。
    *   **对齐**:
        *   题材概念列、股票简称列：通常左对齐。
        *   日期数据列：通常居中对齐。
    *   **边框**: 为所有数据单元格添加细边框。

5.  **整体格式化与调整**:
    *   调整列宽、行高。
    *   冻结首行和首列。
    *   (可选) 添加VBA宏实现悬停高亮。

6.  **保存 Excel 文件**。

## 四、关键函数和模块的复用与修改点

*   **`whimsical.py`**:
    *   `get_trading_days`, `normalize_reason`, `extract_reasons`: 复用。
    *   `process_zt_data` 核心逻辑: 复用或重构以获取 `daily_stocks` 和 `stock_reason_group`。
    *   `get_color_by_pct_change`: 复用，但颜色和阈值需调整以匹配新需求。
*   **`astock_data.py`**:
    *   主要是被动读取其生成的个股日线CSV数据。
    *   注意股票名称在保存和读取时的一致性（如 `*ST` 处理）。

## 五、注意事项与挑战

1.  **数据一致性**: 股票代码和名称在各环节的准确匹配。
2.  **性能**: 优化文件读取，考虑数据缓存。
3.  **数据空缺**: 处理股票未上市、退市、停牌等情况。
4.  **梯队细节**: 明确涨停单元格内显示内容（仅名称，还是名称+板数），板数如何通过颜色体现。
5.  **断板后跟踪天数**: 目前设计是跟踪到分析周期结束。
6.  **颜色映射规则**: 详细定义涨停板数与颜色、涨跌幅与颜色的对应关系。

这个方案提供了一个实现用户需求的详细框架，具体实施中可能需要根据细节进行调整和迭代。
