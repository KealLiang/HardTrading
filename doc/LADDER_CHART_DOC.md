# A股涨停梯队复盘工具 (`ladder_chart.py`) 技术文档

## 1. 功能概述

`ladder_chart.py` 是一个用于A股市场的自动化复盘工具，旨在生成一个可视化的“涨停梯队图”。该工具通过处理每日的涨停、首板、炸板等数据，筛选出市场中的核心连板股，并以Excel表格的形式，直观地展示它们在一段时间内的完整生命周期，包括入选前的酝酿、连板期间的表现、以及断板后的走势。

### 核心产出

该脚本会生成一个多工作表（Sheet）的Excel文件（默认为 `fupan_analysis.xlsx`），主要包含：

1.  **主梯队图 (e.g., `涨停梯队202305`)**: 按时间顺序和概念热度，展示所有满足条件的“显著连板股”的日度表现。
2.  **按概念分组**: 将主梯队图的股票按其核心概念进行分组，便于分析板块效应和轮动。概念组标题行采用合并单元格格式，概念颜色分隔更明显。
3.  **成交量分析**: (可选) 基于成交量涨跌幅的分析表，与主梯队图保持相同的行列结构和格式，包括炸板标记等。
4.  **龙头股**: (可选) 根据连板高度、短期和长周期涨幅等多个维度，从每个概念板块中筛选出龙头股票，形成一个核心股票池。
5.  **指数数据**: 同期主要市场指数（如上证、深证成指、创业板指）的表现，作为市场背景参考。
6.  **图例**: 对表格中使用的颜色、标记等进行详细说明。

这份报告旨在帮助交易员快速复盘市场，洞察主流热点，跟踪强势股的表现，并为后续的交易决策提供数据支持。

---

## 2. 实现思路与核心逻辑

脚本的整体工作流程可以概括为以下几个步骤：

1.  **数据加载 (Data Loading)**:
    *   通过 `analysis.loader.fupan_data_loader.load_stock_data` 加载指定时间周期内的多种数据。
    *   这些数据来源于一个统一的Excel文件 (`excel/fupan_stocks.xlsx`)，其中包含了多个专门的工作表。

2.  **标的筛选 (Stock Selection)**:
    *   这是工具的核心，由 `identify_first_significant_board` 方法实现。
    *   它遍历所有出现过连板或首板的股票，识别出每只股票 **首次达到“显著连板”** 的日期。
    *   “显著连板”的定义是可配置的，例如主板默认`>=2`板，创业板/科创板默认`>=1`板。
    *   **断板重入 (Re-entry)**: 脚本能够处理“断板后再次走强”的情况。如果一只股票在断板超过一个阈值天数（例如4天）后，再次满足“显著连板”条件，它会被视为一条新的记录，重新加入梯队图。
    *   **补充条件 (Attention Criteria)**: （可选）对于一些连板高度未完全达标（例如仅差1板）的股票，如果它在短期内多次出现在“高关注度”列表中，也会被破格纳入分析。

3.  **图表构建与数据填充 (Chart Construction & Data Population)**:
    *   使用 `openpyxl` 库创建一个Excel工作簿。
    *   **表头设置**: 生成日期表头，并在股票名称、代码、概念等基础信息列之后，按时间顺序排列分析周期内的所有交易日。
    *   **行数据填充 (`fill_data_rows`)**: 遍历筛选出的每一条“显著连板”记录，为其创建一行。
        *   **连板期间**: 显示 "N板" 或 "首板"，并根据板高填充不同颜色。
        *   **入选前 (`MAX_TRACKING_DAYS_BEFORE_ENTRY`)**: 显示入选前几天的涨跌幅百分比。
        *   **断板后 (`MAX_TRACKING_DAYS_AFTER_BREAK`)**: 跟踪并显示断板后几天的涨跌幅百分比。
        *   **高增益持续跟踪 (`HIGH_GAIN_TRACKING_THRESHOLD`)**: 即使股票断板后不再涨停，但如果在短期内（如10天）涨幅仍然非常可观（如超过15%），脚本会继续跟踪其后续走势，这对于捕捉“趋势中军”类型的股票很有帮助。

4.  **可视化与信息增强 (Visualization & Information Enhancement)**:
    *   这是该工具最有价值的部分，通过丰富的格式化提供大量额外信息：
        *   **颜色**: 连板高度、涨跌幅、概念板块、高位板（4板以上）、重复入选等都使用不同色系进行区分。
        *   **标记**:
            *   `*` / `**`: 标记创业板/科创板和北交所股票。
            *   `!!`: 标记创`N`日新高（默认为200日）的日期。
            *   `↑` / `↓`: 在股票简称后附加均线（默认5日线）趋势。
            *   `[x.x]`: 在涨跌幅或连板信息后附加当日成交量与前几日均量的比值，用于标识放量或缩量。
        *   **备注 (Comment)**: 在连板单元格的备注中，会显示首次涨停时间、最终涨停时间、开板次数等详细信息。
        *   **下划线**: 标记当天发生过“炸板”行为。

5.  **高级分析 (Advanced Analysis Sheets)**:
    *   **概念分组**: 基于 `utils.theme_color_util` 中的同义词和概念分层逻辑，为每只股票打上核心概念标签。然后生成一个按概念聚合、并按概念内股票强度排序的新工作表。
    *   **龙头筛选**: 在概念分组的基础上，通过 `select_leader_stocks_from_concept_groups` 方法，根据连板高度、短/长周期涨幅等硬性指标，筛选出每个板块的龙头股，并生成独立的工作表。

---

## 3. 数据源说明

所有输入数据均由 `analysis/loader/fupan_data_loader.py` 模块从 `excel/fupan_stocks.xlsx` 文件中加载。该Excel文件必须包含以下格式的工作表：

*   **`连板数据`**:
    *   **结构**: 日期为列，每日的连板股信息填在对应日期的单元格中。
    *   **单元格格式**: 一个由分号`;`分隔的长字符串。
    *   **字段顺序**: `股票代码; 股票简称; 涨停开板次数; 最终涨停时间; 几天几板; 最新价; 首次涨停时间; 最新涨跌幅; 连续涨停天数; 涨停原因类别`。
    *   **作用**: 提供核心的连板股票池和详细的涨停信息。

*   **`首板数据`**, **`炸板数据`**:
    *   **结构与格式**: 与`连板数据`表类似，日期为列，单元格为分号分隔的字符串。
    *   **作用**: `首板数据`用于补充1进2的梯队情况；`炸板数据`用于在图表上标记当日有开板行为的股票。

*   **`关注度榜` / `非主关注度榜`** (可选):
    *   **结构与格式**: 同样以日期为列，分号分隔字符串。
    *   **字段顺序**: `股票代码; 股票名称; 最新价; 最新涨跌幅; 个股热度; 个股热度排名`。
    *   **作用**: 当启用 `--enable_attention_criteria` 参数时，为那些连板高度略有欠缺但市场关注度极高的股票提供一个额外的入选通道。

---

## 4. 关键依赖与模块解析

### 4.1 `utils/theme_color_util.py` (概念处理与颜色主题核心)

该模块是实现概念驱动分析和可视化效果的基石。

*   **思路**:
    1.  **概念归一化**: 市场的概念表述多样（如"AI服务器"和"CPO"），需要统一到标准概念（如"算力半导体"）。这通过一个预定义的同义词词典 `synonym_groups` 来实现。
    2.  **热点识别**: 并非所有概念都同等重要。脚本会统计在分析周期内各个标准概念的出现频率。
    3.  **颜色分配**: 选出频率最高、或被手动设为优先的Top N个概念，为它们分配独特的、醒目的颜色，用于在Excel中高亮。
*   **关键方法**:
    *   `normalize_reason()`: 核心的归一化函数。输入一个原始概念字符串，通过匹配同义词词典，返回其所属的标准概念。支持通配符和最长匹配原则，以确保准确性。
    *   `get_reason_colors()`: 统计所有概念的词频，结合`PRIORITY_REASONS`（优先概念）和`EXCLUDED_REASONS`（排除概念），筛选出Top N热门概念并返回一个`{概念: 颜色}`的映射字典。
    *   `get_stock_reason_group()`: 为一只拥有多个概念的股票，确定其最核心的归属概念。其规则是：优先选择在Top N热门概念列表中的概念。
    *   **高级打分系统**: 模块内还包含一套基于概念“正统度”的打分模型（`score_reason`），可以根据概念的层级、角色、是否包含核心关键词等维度进行综合打分，以更精确地确定股票的核心驱动逻辑。

### 4.2 `analysis/abnormal_movement_detector.py` (异动检测模块)

该模块模拟了交易所的股价异动监控规则，用于提前预警。

*   **思路**:
    1.  **规则定义**: 模块严格遵循公开的异动规则，如“连续3个交易日内日收盘价格涨跌幅偏离值累计达到±20%”为异常波动，“10个交易日内累计偏离值达到100%”为严重异常波动。
    2.  **偏离值计算**: 偏离值 = 股票真实涨跌幅 - 同期对应板块指数的涨跌幅。为此，模块会预加载各主要指数（上证、创业板、科创50等）的数据。
    3.  **预警机制**: 除了判断是否 **已触发** 异动，该模块的核心价值在于 **预判**。它会计算当前累计偏离值距离触发阈值还差多少，并生成如“上涨X%将触发异动”的预警信息。
*   **关键方法**:
    *   `calculate_cumulative_deviation()`: 精确计算一只股票在N个交易日内相对于其基准指数的累计偏离值。该方法使用复利计算，而非简单的日度偏离值相加，结果更准确。
    *   `check_abnormal_movement()` / `check_severe_abnormal_movement()`: 分别检查是否已触发普通异动和严重异动。
    *   `get_warning_message()`: `ladder_chart.py` 调用的主接口。它会综合所有规则（已触发的和即将触发的），并根据预设的优先级，返回最紧急、最重要的一条预警信息。

---

## 5. 关键方法详解

-   `build_ladder_chart()`: **(入口与总调度)**
    *   这是最顶层的函数，负责调用所有子模块，完成从数据加载、分析、到最终Excel文件生成的完整流程。它接收所有命令行参数，并对整个过程进行计时。

-   `identify_first_significant_board()`: **(核心筛选逻辑)**
    *   输入原始的连板和首板数据（透视后的DataFrame，行为股票，列为日期）。
    *   内部逐一分析每只股票的时间序列，使用 `is_stock_significant` 判断是否达到显著连板门槛。
    *   通过 `check_reentry_condition` 检查断板后的重入情况。
    *   输出一个处理好的DataFrame `result_df`，每行代表一次有效的“显著连板事件”，包含了事件的起始日期、当时的板高、股票信息等。

-   `fill_data_rows()` 和 `fill_single_stock_row()`: **(数据填充)**
    *   遍历 `result_df` 中的每只股票。
    *   对分析周期内的每一天，调用 `process_daily_cell` 来决定该单元格应如何显示：是显示“N板”、"首板"、涨跌幅百分比，还是留白。
    *   调用 `abnormal_movement_detector` 模块来获取异动预警信息并填充到最后一列。

-   `create_concept_grouped_sheet_content()`: **(概念分组视图生成)**
    *   接收 `result_df`，并根据 `concept_group` 和 `long_period_change` (长周期涨幅) 等字段进行二次排序。
    *   在 `fill_data_rows_with_concept_groups` 中，它会在不同概念板块之间插入带颜色的标题行，使板块结构一目了然。

-   `select_leader_stocks_from_concept_groups()`: **(龙头股筛选)**
    *   这是龙头股工作表的筛选核心。它对每个概念分组内的股票，应用一系列硬性过滤条件（如最低连板数、最低短/长周期涨幅），然后对满足条件的股票进行排序，选出每个概念的Top N。

---

## 6. 参数配置

脚本提供了丰富的全局变量和命令行参数，以适应不同的市场环境和分析需求。

### 6.1 全局核心参数 (在代码文件顶部定义)

| 参数名 | 默认值 | 描述 |
| --- | --- | --- |
| `MAX_TRACKING_DAYS_AFTER_BREAK` | 9 | 断板后，继续跟踪其每日涨跌幅的最大天数。超过此天数则不再显示。 |
| `MAX_TRACKING_DAYS_BEFORE_ENTRY` | 5 | 入选为显著连板股之前，回溯显示其每日涨跌幅的最大天数。 |
| `REENTRY_DAYS_THRESHOLD` | 4 | 断板后，如果间隔超过此交易日数再次满足入选条件，则视为新的一条记录。 |
| `PERIOD_DAYS_CHANGE` | 10 | 用于计算短周期（如近10日）涨跌幅。 |
| `PERIOD_DAYS_LONG` | 30 | 用于计算长周期（如近30日）涨跌幅。 |
| `HIGH_GAIN_TRACKING_THRESHOLD` | 15.0 | 持续跟踪的涨幅阈值(%)。若股票在`PERIOD_DAYS_CHANGE`天内涨幅超过此值，即使没涨停也会被持续跟踪。 |
| `NEW_HIGH_DAYS` | 200 | 计算N日新高的周期，例如200日新高。 |
| `MIN_BOARD_LEVEL_FOR_LEADER` | 2 | 筛选龙头股时的最低连板高度要求。 |
| `VOLUME_DAYS` | 4 | 计算N日平均成交量的天数。 |
| `VOLUME_RATIO_THRESHOLD` | 2.2 | 成交量比值高阈值，超过则在单元格中标记。 |
| `MA_SLOPE_DAYS` | 5 | 计算N日均线斜率的天数。 |
| `MA_SLOPE_THRESHOLD_PCT` | 2 | 均线斜率变化的百分比阈值，超过此值才显示趋势箭头。 |

### 6.2 命令行参数 (`if __name__ == "__main__"`)

| 参数 | 描述 |
| --- | --- |
| `--start_date`, `--end_date` | 分析的开始和结束日期 (YYYYMMDD)。 |
| `--output` | 输出Excel文件的路径。 |
| `--min_board` | 主板股票被视为“显著”所需的最低连板天数。 |
| `--non_main_board` | 非主板股票（创业板、科创板、北交所）被视为“显著”的最低连板天数。 |
| `--show_period_change` | 是否在表格中显示短/长周期涨跌幅列。 |
| `--priority_reasons` | 优先概念列表，逗号分隔。这些概念在排序时会被置于更优先的位置。 |
| `--enable_attention_criteria` | 是否启用“关注度”作为补充筛选规则。 |
| `--sheet_name` | 指定生成的主工作表名称，可用于在同一个Excel文件中创建多个分析报告。 |
| `--create_leader_sheet` | 是否创建龙头股工作表。 |

---

## 7. 【默默上涨】功能说明

### 7.1 功能概述

【默默上涨】功能是一个独立的股票筛选和跟踪模块，用于识别和跟踪那些"30天涨幅大于等于55%，30天无涨停，非ST，非近新股"的股票。这些股票通常表现为稳步上涨而非爆发式涨停，具有独特的投资价值。

### 7.2 实现特点

-   **独立数据源**: 从`excel/fupan_stocks.xlsx`的【默默上涨】sheet读取数据
-   **独立入选逻辑**: 3个月以内的数据都入选，注意去重
-   **独立跟踪逻辑**: 基于近期跌幅阈值的持续跟踪机制
-   **独立概念显示**: 使用"区间成交额"和"区间涨跌幅:前复权"填充概念列
-   **完整格式化支持**: 包括【近10日/近30日】列和【异动预警】列的计算

### 7.3 关键参数

| 参数名 | 默认值 | 描述 |
| --- | --- | --- |
| `MAX_TRACKING_DAYS_BEFORE_ENTRY_MOMO` | 10 | 【默默上涨】入选前跟踪的最大天数 |
| `MOMO_DECLINE_THRESHOLD` | -25.0 | 【默默上涨】持续跟踪的跌幅阈值(%) |
| `MOMO_ENTRY_MONTHS` | 3 | 【默默上涨】入选的月数范围 |

### 7.4 数据格式

【默默上涨】数据格式为：`股票代码; 股票简称; 最新价; 最新涨跌幅; 区间涨跌幅; 区间成交额; 区间振幅; 上市交易日天数`

### 7.5 显示特点

-   **入选日期**: 显示"默默上涨 XX%"标记，使用紫色背景
-   **其他日期**: 显示日涨跌幅，与连板股票保持一致的格式
-   **概念分组**: 作为独立的"默默上涨"分组出现在【涨停梯队 按概念分组】sheet中
-   **排序优先级**: 设置较低优先级，通常排在概念分组的最后

## 8. 格式统一优化

### 8.1 概念分组格式统一

为了提高用户体验，主梯队图和成交量分析表的格式已经统一：

1. **概念组标题行**: 两个表的概念组标题行都采用合并单元格格式，从第一列开始合并到最后一列，概念颜色分隔更加明显。
2. **行列结构一致**: 成交量分析表与主梯队图保持相同的行数和列数，便于用户在两个表之间切换对比。
3. **炸板格式共享**: 成交量分析表复用主梯队图的炸板格式计算结果，确保炸板标记（双底框线和下划线）在两个表中完全一致。

### 8.2 炸板格式缓存机制

为了提高性能并确保格式一致性，系统实现了炸板格式缓存机制：

- **缓存存储**: 在处理主梯队图时，将每只股票每日的炸板状态缓存到全局变量中。
- **缓存复用**: 成交量分析表优先使用缓存的炸板信息，避免重复计算。
- **格式一致**: 确保两个表中的炸板格式（下划线和双底框线）完全一致。

## 9. 使用与维护建议

### 9.1 使用示例

在终端中执行以下命令来运行脚本：
```bash
# 激活虚拟环境 (Windows)
.venv-3.11\Scripts\activate

# 运行一个基本的分析
python analysis/ladder_chart.py --start_date 20230501 --end_date 20230531

# 运行一个包含周期涨跌幅和龙头股筛选的复杂分析
python analysis/ladder_chart.py --start_date 20230501 --end_date 20230531 --show_period_change --create_leader_sheet --priority_reasons "AI,机器人,中特估"

# 运行包含【默默上涨】功能的分析
python analysis/ladder_chart.py --start_date 20230501 --end_date 20230531 --show_period_change --enable_momo_shangzhang
```

### 9.2 维护建议

-   **数据源是基础**: `fupan_data_loader.py` 的稳定性和`excel/fupan_stocks.xlsx`的数据质量直接决定了本工具的准确性。
-   **概念逻辑是核心**: 市场的概念是不断变化的。大部分关于概念的调整（如同义词合并、概念分层、热点颜色）都应在 `utils/theme_color_util.py` 和其引用的 `data/reasons/` 目录下的同义词文件中进行。
-   **参数化与灵活性**: 脚本已经高度参数化。对于新的分析维度，建议遵循现有模式：在文件顶部添加新的全局配置参数 -> 实现计算指标的函数 -> 在 `fill_single_stock_row` 中调用 -> 创建新的 `format_*` 函数决定其在Excel中的展示样式。
-   **性能考虑**: 脚本中大量使用了 `@lru_cache` 来缓存文件IO和重复计算，这是非常好的实践。在添加新功能时，对于会被频繁调用的函数（特别是涉及文件读写的），应优先考虑使用缓存。
-   **【默默上涨】维护**: 【默默上涨】功能的核心逻辑在`analysis/momo_shangzhang_processor.py`中，跟踪逻辑可根据市场情况调整相关参数。