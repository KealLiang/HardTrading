# A股量化自动交易执行层详设（以 QMT 为主，含替代方案）

> 仅讨论“自动买入/卖出/撤单”等执行层，不涉及策略选股与信号生成。

## 1. 目标与范围

- 明确在 A 股场景下，如何落地自动化交易（委托、撤单、查询、风控、监控）的系统设计。
- 首选接入：QMT（迅投量化交易平台，Python/本地 API 形态）。
- 同类/替代接入方案：券商极速柜台 API（如 XTP 等）+ 第三方网关（如 vn.py），以及其他桥接方案的取舍对比。
- 输出：执行架构、模块职责、关键流程、风控要点、运行与运维、测试计划与注意事项。

## 2. 约束与前置条件（A 股实务）

- 交易制度：T+1、涨跌停限制、集合竞价与连续竞价、不同交易所的市价类型支持差异。
- 合规限制：撤单频次与比例、异常交易行为监控、账号权限与风控阈值（由券商/柜台侧实现）。
- 委托单位与精度：价格最小变动价位、数量步长（常见为 100 股整数倍，ETF/可转债等以交易所细则为准）。
- 环境要求：Windows 交易机常驻、时钟同步（NTP）、稳定低抖动网络、QMT 客户端保持在线且解锁（若有）。

## 3. 总体架构

### 3.1 组件划分

- 行情模块（可选）：订阅与快照缓存（若策略侧已产出信号，可不在执行侧拉行情）。
- 执行网关（本项目核心）：
  - 与 QMT/柜台 API 交互（下单/撤单/查询）。
  - 订单管理（OMS）：订单簿、成交簿、持仓/资金镜像、状态机、重试与幂等。
  - 预交易风控：资金/仓位/价格/频控校验。
  - 运行监控与审计日志：指标上报、异常告警、全链路留痕。
- 外部策略引擎：产出标准化交易指令（signal->order）。与执行网关通过本地消息队列/HTTP/RPC 通信。
- 存储层：
  - 热数据：内存 + 持久化（本地 SQLite/文件或远端数据库）。
  - 冷数据：日终归档（订单/成交/日志）。

### 3.2 交互关系（文本示意）

```
[策略引擎] --(标准下单/撤单指令)--> [执行网关]
[执行网关] <==> [QMT/券商柜台]
[执行网关] --(结构化日志/指标)--> [监控&告警]
[执行网关] <==> [存储(订单/成交/资金/持仓)]
```

## 4. 环境与部署

- 操作系统：Windows 11（交易机）；建议专机独占、关闭自动更新与休眠。
- QMT 客户端：安装并登录目标券商账号；开启本地 API/自动化接口权限（以券商与版本为准）。
- Python 环境：建议使用项目提供的虚拟环境（conda 环境 `trading`）。
- 时钟：NTP 对时，最大漂移 < 100ms；用于撮合时段切换与风控。
- 网络：专线/低抖动网络，冗余链路可选。

## 5. QMT 接入详设（执行层）

> 本节基于 QMT 的本地 API（常见为 Python SDK 形态，如 xtquant/xtdata 等模块，具体以实际版本为准）。

### 5.1 会话与连接

- 启动：确保 QMT 客户端已登录且保持在线，执行进程初始化本地 API 句柄。
- 心跳与重连：维持与本地 API 会话；断连自检（心跳超时、调用异常）后重建句柄，恢复订阅与查询。
- 多账户：同机多账户需进程隔离或多会话管理，区分账户级资源（资金、限额、频控）。

### 5.2 订单模型（统一抽象）

- 字段建议：
  - clientOrderId（本地唯一、可追踪、便于幂等）
  - accountId / brokerId / exchange（账户、券商、交易所）
  - symbol（证券代码，含交易所后缀如 SH/SZ）
  - side（BUY/SELL）
  - priceType（LIMIT / 市价类型占位，依交易所支持差异抽象）
  - price（限价时必填，精度按最小价位步长校验）
  - quantity（按最小申报单位校验）
  - timeInForce（GFD/IOC/FOK 等，受交易所支持限制，通常以限价 GFD 为主）
  - extraFlags（如现金替代、融资融券标记等，按需扩展）

### 5.3 下单流程

1. 规范化指令入参（符号格式、方向、价格精度、数量步长）。
2. 预交易风控：
   - 资金可用、持仓可用检查；
   - 价格越界（涨跌停、最小价位步长）；
   - 数量越界（最小成交单位、账户/品种限额）；
   - 频控（每秒委托上限、撤单比控制）。
3. 生成 `clientOrderId`，落日志（待发送）。
4. 调用 QMT 下单接口；记录 API 回执（包含柜台 `orderId`）。
5. 建立订单簿记录：状态 `New -> Submitted`。

### 5.4 撤单流程

1. 触发条件：
   - 超时未成交；
   - 价格偏离/盘口变化；
   - 策略切换/风控触发；
   - 收盘前清理挂单。
2. 通过 `orderId` 调用撤单接口；
3. 更新订单状态；对返回/回报做幂等处理（在途撤、已成、已撤）。

### 5.5 状态机与回报

- 典型状态映射：
  - New → Submitted → PartiallyFilled → Filled
  - Submitted → Rejected（拒单）
  - Submitted/PartiallyFilled → Canceled（撤单成功）
- 回报处理：
  - 去重（按 `orderId` 与成交回报唯一键）；
  - 顺序性保障（乱序回报通过版本号/时间戳矫正）；
  - 事件驱动更新订单簿、成交簿、持仓/资金镜像。

### 5.6 行情与价格类型

- A 股市价委托的支持类型在沪深交易所存在差异；为兼容性与控制滑点，执行层建议默认使用“限价单”。
- 若需市价类委托，执行层需对“即时成交剩余撤销/转限价”等进行抽象与保护（跌停/涨停附近的成交失败与反复撤补）。

### 5.7 容错与恢复

- 执行进程重启：
  - 启动时从 QMT 查询当日委托/成交，重建本地订单簿与持仓/资金镜像；
  - 对处于在途状态订单设置“恢复检查任务”（拉取状态直到终态）。
- API 调用失败：
  - 可重试错误（网络抖动）指数回退；
  - 不可重试错误（合规/参数/交易所拒绝）直接标记终态并告警。

## 6. OMS（订单管理）与风控

### 6.1 订单管理

- 委托簿：维护订单生命周期、时间轴、外部与柜台 ID 映射。
- 成交簿：逐笔累积，计算成交均价、成交量、剩余量。
- 持仓/资金镜像：以柜台查询为准，订单侧推导仅作预估；出现不一致时以柜台侧矫正。
- 日切：收盘后冻结当日数据，归档备份，第二天启动时回灌。

### 6.2 预交易与交易中风控

- 资金/仓位：可用额度、单票/单笔上限、净敞口限制。
- 价格边界：涨跌停、盘口差、最小价位步长。
- 频控与撤单比：限制每秒委托数、撤单比例与冷静期。
- 止损/止盈（执行侧可选）：若策略侧未实现，可在执行侧设置兜底机制。

## 7. 日志、指标与告警

- 结构化日志：包含 `timestamp、accountId、clientOrderId、orderId、symbol、side、price、qty、action、result、errorCode、latencyMs` 等字段。
- 关键指标：
  - 下单/撤单成功率、拒单率、成交率；
  - API 调用耗时 p50/p95/p99；
  - 重连次数、在途订单规模、撤单比。
- 告警：
  - 心跳断连、登录失效、连续拒单、资金/持仓不一致；
  - 重要时间点（开盘/收盘）前后的异常。

## 8. 安全与合规

- 账号安全：最小权限运行、凭据加密存储（本机 DPAPI 或硬件加密）。
- 操作留痕：全量审计日志与只读归档。
- 合规：遵守交易所与券商风控规则，避免异常撤单/频繁报撤/自成交等行为；必要时与券商风控同学沟通设定阈值。

## 9. 运维与发布

- 启停流程：
  - 启动前检查：网络、时钟、QMT 登录状态、账户可用；
  - 启动：先加载镜像与在途恢复，再开放对外接入；
  - 停机：先禁止新单，等待在途单进入终态/批量撤单，再优雅退出。
- 配置管理：账户、品种白名单、价格/数量限制、频控参数、时段参数（集合竞价/午休/收盘）。
- 版本发布：交易时段外灰度，具备一键回滚脚本。

## 10. 方案对比与替代接入

> 实盘接入需以目标券商支持为准，以下为常见路径与取舍建议。

- QMT（本地 API）
  - 优点：部署门槛低、Python 友好、生态资料多、支持多券商插件形态；
  - 注意：需保持客户端在线；不同券商插件能力/稳定性可能差异；市价类型兼容需自测。
- 券商极速柜台 API（如 XTP 等）+ 第三方网关（如 vn.py）
  - 优点：专业交易接口、低延迟、行情/交易分离清晰；
  - 注意：需券商开通权限与席位；接入复杂度较高；需自建更多监控与恢复逻辑。
- UI 自动化桥接（模拟键鼠驱动客户端）
  - 不推荐：脆弱、隐性合规风险高、容错差；仅可用于研究与极端兜底场景。

结论：优先采用 QMT（快速上线与验证），对低延迟/高并发与定制化要求强的团队可评估 XTP 等柜台直连方案。

## 11. 测试计划

- 环境：优先使用仿真/模拟盘（QMT 仿真或券商柜台仿真）。
- 功能用例：
  - 下单成功/拒单、部分成交/全部成交、撤单成功/已成不可撤；
  - 集合竞价下单、收盘前批量撤单；
  - 涨跌停保护、最小价位与数量校验；
  - 断连/重连与在途恢复、重复回报去重。
- 性能用例：
  - 峰值委托 TPS 与端到端延迟统计；
  - 撤单率与撤单延迟；
  - 恢复时间（进程/网络故障）。

## 12. 与本项目的集成建议

- 进程形态：在 `main.py` 中新增“执行服务”入口（如 `--exec-service`），监听策略侧指令并调用 QMT API；
- 配置：在 `config/` 中新增账户/风控/时段配置文件；
- 日志：输出到 `logs/`，结构化 JSON 便于聚合；
- 测试：在 `tests/` 增加模拟回报与状态机单测（不联网）。

> 注：本次仅提供文档设计，未交付任何交易代码实现。

## 13. 风险清单

- 外部依赖不稳定：QMT 客户端/插件版本差异、网络抖动；
- 合规阈值未知：撤单比/频控阈值需与券商确认；
- 市价兼容差异：沪深交易所支持的市价类型不同，需针对性测试；
- 时序问题：回报乱序或延迟导致本地镜像短暂不一致，需要最终以柜台查询矫正。

## 14. 下一步实施清单（里程碑）

1. 明确券商与接入形态（QMT 版本与插件、或 XTP 仿真）。
2. 打通最小闭环：限价买入/卖出/撤单 + 订单状态跟踪 + 成交回报落地。
3. 补齐预交易风控与频控；实现在途恢复与日切归档。
4. 接入监控与告警（断连、拒单率、延迟）。
5. 小资金仿真/实盘灰度验证；逐步提高并发与覆盖的证券池。 