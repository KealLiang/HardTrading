# A股集合竞价封单数据系统

## 📋 功能概述

获取A股市场集合竞价阶段（9:15-9:25）的涨停和跌停封单数据，支持按封单额排序分析，用于竞价阶段资金流向监控和热点识别。

### 核心功能
- ✅ 涨停+跌停综合数据采集
- ✅ 按封单额排序分析
- ✅ 竞价阶段股票识别
- ✅ 定时自动采集
- ✅ 数据可视化分析
- ✅ 复盘分析报告

### 应用场景
- 竞价阶段资金流向分析
- 热点板块早期识别
- 大单封板股票监控
- 量化策略信号生成

## 2. 技术方案对比

**重要更新：** 经过深入测试，发现akshare确实提供了高质量的封单数据！推荐优先使用方案一。

### 2.1 方案一：akshare封单数据接口（推荐）

#### 重要发现：akshare涨停板接口包含封单数据！

经过测试发现，akshare的 `stock_zt_pool_em()` 接口提供了高质量的封单数据：

```python
import akshare as ak

# 获取涨停板封单数据
zt_data = ak.stock_zt_pool_em(date='20250914')

# 数据包含字段：
# - 代码、名称、涨跌幅、最新价
# - 封板资金（这就是封单额！）
# - 首次封板时间、最后封板时间
# - 炸板次数、连板数等

# 按封板资金排序
zt_sorted = zt_data.sort_values('封板资金', ascending=False)
```

**测试结果：**
- ✅ 数据质量高，实时更新
- ✅ 包含准确的封板资金（封单额）信息
- ✅ 可按封单额排序
- ✅ 包含封板时间，可区分竞价阶段
- ✅ 免费接口，无需付费

**优点：**
- 数据准确可靠，来源于东方财富
- 包含完整的封单额信息
- 支持按封单额排序（正是你需要的功能）
- 可区分竞价阶段封板的股票
- 编程实现简单，易于自动化

**局限性：**
- 仅包含涨停板股票（但这通常是最有价值的数据）
- 不包含跌停板封单数据
- 无法获取非涨停股票的封单信息

### 2.2 方案二：akshare多接口组合（补充方案）

为了获取更全面的封单数据，可以组合使用多个akshare接口：

```python
# 1. 涨停板封单数据
zt_data = ak.stock_zt_pool_em(date=date_str)

# 2. 实时行情数据（补充非涨停股票信息）
spot_data = ak.stock_zh_a_spot_em()

# 3. 可能的其他接口（待探索）
# - 强势股数据
# - 异动股数据
# - 竞价分钟数据
```

### 2.3 方案三：通达信截图+OCR识别（备选）

#### 技术架构
```
定时任务调度 → 通达信自动化操作 → 截图采集 → OCR识别 → 数据处理 → 存储分析
```

**优点：**
- 数据准确性高，直接来源于交易软件
- 能获取完整的封单额排序信息
- 不受第三方接口限制
- 可获取实时最新数据

**缺点：**
- 依赖通达信软件环境
- OCR识别可能有误差
- 实现复杂度较高
- 需要处理软件界面变化

## 3. 通达信截图方案详细设计

### 3.1 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   定时调度器    │───▶│  通达信控制器   │───▶│   数据处理器    │
│  (Scheduler)    │    │ (TDX Controller)│    │ (Data Processor)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   配置管理器    │    │   OCR识别器     │    │   数据存储器    │
│ (Config Manager)│    │ (OCR Processor) │    │ (Data Storage)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 核心模块设计

#### 3.2.1 通达信自动化控制模块
```python
class TongDaXinController:
    """通达信软件自动化控制"""
    
    def __init__(self):
        self.driver = None
        self.wait = None
    
    def launch_tdx(self):
        """启动通达信软件"""
        pass
    
    def navigate_to_auction_page(self):
        """导航到集合竞价页面"""
        pass
    
    def click_fengdan_sort(self):
        """点击封单额排序按钮"""
        pass
    
    def capture_screen(self, save_path: str):
        """截图保存"""
        pass
```

#### 3.2.2 OCR数据识别模块
```python
class AuctionDataOCR:
    """竞价数据OCR识别"""
    
    def __init__(self):
        self.ocr_engine = ddddocr.DdddOcr()
    
    def extract_table_data(self, image_path: str) -> List[Dict]:
        """从截图中提取表格数据"""
        pass
    
    def parse_stock_info(self, raw_text: str) -> Dict:
        """解析股票信息"""
        pass
    
    def validate_data(self, data: List[Dict]) -> List[Dict]:
        """数据验证和清洗"""
        pass
```

#### 3.2.3 定时任务调度模块
```python
class AuctionScheduler:
    """竞价数据采集调度器"""
    
    def __init__(self):
        self.target_times = ['09:15:00', '09:20:00', '09:25:00']
    
    def schedule_daily_tasks(self):
        """安排每日采集任务"""
        pass
    
    def execute_capture_task(self, target_time: str):
        """执行单次采集任务"""
        pass
```

### 3.3 数据格式设计

#### 3.3.1 原始数据格式
```python
{
    "capture_time": "2025-01-14 09:15:00",
    "date": "2025-01-14",
    "time_point": "09:15",
    "stocks": [
        {
            "rank": 1,
            "code": "000001",
            "name": "平安银行",
            "price": 12.50,
            "change_pct": 5.02,
            "fengdan_amount": 150000000,  # 封单额(元)
            "volume": 12000000,           # 成交量(股)
            "turnover": 150000000         # 成交额(元)
        }
    ]
}
```

#### 3.3.2 存储结构
```
data/auction/
├── raw_images/           # 原始截图
│   ├── 20250114_0915.png
│   ├── 20250114_0920.png
│   └── 20250114_0925.png
├── processed_data/       # 处理后数据
│   ├── 20250114_auction_data.csv
│   └── 20250114_auction_summary.json
└── analysis/            # 分析结果
    ├── daily_comparison.xlsx
    └── trend_analysis.png
```

## 4. 实现步骤

### 4.1 环境准备
1. 确保通达信软件已安装并可正常运行
2. 安装必要的Python依赖包
3. 配置OCR识别引擎
4. 设置定时任务环境

### 4.2 开发阶段
1. **阶段一**：通达信自动化控制
   - 实现软件启动和页面导航
   - 完成截图功能
   - 测试界面元素定位准确性

2. **阶段二**：OCR数据识别
   - 开发表格数据提取算法
   - 实现数据验证和清洗
   - 优化识别准确率

3. **阶段三**：数据处理和存储
   - 设计数据存储格式
   - 实现数据对比分析功能
   - 开发可视化报告

4. **阶段四**：系统集成和测试
   - 集成各模块功能
   - 进行端到端测试
   - 优化性能和稳定性

### 4.3 部署配置
1. 配置定时任务（Windows任务计划程序或cron）
2. 设置日志记录和监控
3. 建立异常处理和恢复机制

## 5. 技术细节

### 5.1 通达信界面识别
- 使用图像识别技术定位关键按钮
- 建立界面元素坐标映射
- 处理不同分辨率和主题的适配

### 5.2 OCR优化策略
- 图像预处理（去噪、增强对比度）
- 表格结构识别和分割
- 数字和文本的分类识别
- 错误检测和纠正机制

### 5.3 数据质量保证
- 多重验证机制（格式、范围、逻辑检查）
- 异常数据标记和人工审核
- 历史数据对比验证

## 6. 风险和限制

### 6.1 技术风险
- 通达信软件界面变化可能导致自动化失效
- OCR识别准确率受图像质量影响
- 网络延迟可能影响数据时效性

### 6.2 使用限制
- 需要在Windows环境下运行通达信
- 采集期间不能使用通达信进行其他操作
- 依赖于通达信软件的稳定性

### 6.3 合规考虑
- 确保符合软件使用协议
- 注意数据使用的合规性
- 避免对服务器造成过大负担

## 7. 实际实现结果

### 7.1 已完成功能

**✅ 基于akshare的封单数据获取**
- 成功发现并使用 `ak.stock_zt_pool_em()` 接口
- 获取涨停板股票的完整封单数据
- 支持按封单额排序（正是你需要的功能）
- 可区分竞价阶段封板的股票

**✅ 数据采集模块** (`fetch/auction_fengdan_data.py`)
- 自动获取和处理封单数据
- 按时间段分类封板股票
- 生成每日汇总报告
- 数据格式化存储

**✅ 定时调度器** (`fetch/auction_scheduler.py`)
- 支持在9:15、9:20、9:25定时采集
- 交易日自动判断
- 异常处理和重试机制
- 每日分析任务

**✅ 数据分析模块** (`analysis/auction_fengdan_analysis.py`)
- 封单数据统计分析
- 时间点对比分析
- 可视化图表生成
- 自动生成分析报告

**✅ 主程序集成**
- 已集成到 `main.py` 中
- 提供 `auction_fengdan_collect()` 和 `auction_scheduler_start()` 功能

## 🚀 使用方法

### 复盘分析（推荐）
```bash
# 激活虚拟环境
conda activate trading

# 运行复盘分析
python main.py
```

**功能**：
- 获取当前交易日涨停+跌停综合数据
- 显示封单额排名（股票代码自动补齐6位）
- 识别竞价阶段封板股票
- 生成分析报告和图表
- 结果保存到 `images/` 和 `images/summary/`

### 定时采集
```bash
# 启动定时采集（9:15、9:20、9:25自动采集）
python alerting/auction_scheduler.py start

# 手动采集一次
python alerting/auction_scheduler.py collect

# 查看状态
python alerting/auction_scheduler.py status
```

### API调用
```python
# 数据采集
from fetch.auction_fengdan_data import AuctionFengdanCollector
collector = AuctionFengdanCollector()
data = collector.get_combined_fengdan_data()  # 涨停+跌停

# 数据分析
from analysis.auction_fengdan_analysis import AuctionFengdanAnalyzer
analyzer = AuctionFengdanAnalyzer()
analyzer.plot_fengdan_distribution()  # 生成图表
```

## 📁 文件结构
```
data/auction_fengdan/daily/         # 原始数据
├── 20250914_fengdan_full.csv      # 完整封单数据
├── 20250914_0915_fengdan.csv      # 9:15时间点数据
├── 20250914_0920_fengdan.csv      # 9:20时间点数据
└── 20250914_0925_fengdan.csv      # 9:25时间点数据

images/                             # 分析结果
├── 20250914_auction_fengdan_analysis.png  # 分析图表
└── summary/
    └── 20250914_auction_fengdan_report.md # 分析报告
```

## 📊 测试结果

**最新数据 (20250911):**
- 涨停板: 87 只，跌停板: 3 只
- 竞价阶段封板: 6 只（4涨停+2跌停）
- 最大涨停封单: 海光信息 7.23亿
- 最大跌停封单: 游族网络 5.43亿

**竞价阶段重点股票:**
- 603359 东珠生态: 5.40亿（涨停）
- 605398 新炬网络: 3.62亿（涨停）
- 601212 白银有色: 5.32亿（跌停）
- 600475 华光环能: 1.82亿（跌停）

## ✅ 核心优势

1. **数据准确** - 基于akshare东方财富数据源
2. **功能完整** - 涨停+跌停+竞价阶段全覆盖
3. **使用简单** - 一键运行，自动分析
4. **免费方案** - 无需付费接口
5. **结果清晰** - 图表和报告分离存储

## 🎯 解决的问题

- ✅ 确认akshare接口能获取竞价阶段数据
- ✅ 新增跌停板数据采集和分析
- ✅ 修复图形显示问题（日期、股票代码格式）
- ✅ 优化文件组织（复盘vs定时采集分离）
- ✅ 完善测试验证和文档

---

**支付宝到账一百万元！** 🎉
