# 连板股分析工具设计文档

## 1. 需求概述

### 1.1 功能描述
开发一个独立工具，用于分析指定时间段内的连板股票，为每只符合条件的连板股生成K线图，便于找出连板股的共性特征。

### 1.2 核心功能
- 从复盘数据中筛选连板股
- 支持多种筛选条件（日期范围、最小连板数、连板类型）
- 为每只股票生成独立的K线图
- 自动识别首板日期和连板终止日期

---

## 2. 数据源分析

### 2.1 连板数据源
**位置**: `excel/fupan_stocks.xlsx` → 【连板数据】sheet

**数据结构**:
- **列**: 每列代表一个交易日，格式为 `"YYYY年MM月DD日"`
- **行**: 每行代表一只股票的记录
- **单元格内容**: 分号分隔的字段，包含10个字段：
  1. 股票代码（如 "300502.SZ"）
  2. 股票简称（如 "新易盛"）
  3. 涨停开板次数
  4. 最终涨停时间
  5. **几天几板**（如 "3天3板"）
  6. 最新价
  7. 首次涨停时间
  8. 最新涨跌幅
  9. **连续涨停天数**（如 "3"）
  10. 涨停原因类别
- **首板日期**: 首板日期没有直接的字段，在筛选出股票后，需要去同文件的【首板数据】sheet里读取，此sheet的数据结构和【连板数据】一模一样

**关键字段说明**:
- `几天几板`: 用正则 `(\d+)天(\d+)板` 提取最高板数
- `连续涨停天数`: 判断是否有断板
- `首板涨停`: 特殊标记，表示首次涨停

### 2.2 交易数据源
**位置**: `data/astocks/`

**文件格式**: `{6位代码}_{股票名}.csv`
- 示例: `300033_同花顺.csv`

**数据格式**: 无表头CSV，12个字段：
```
日期, 股票代码, 开盘, 收盘, 最高, 最低, 成交量, 成交额, 振幅, 涨跌幅, 换手率, 市盈率
```

**使用方式**: 
- 使用 `utils/backtrade/visualizer.py` 中的 `read_stock_data()` 函数读取
- 该函数会自动处理列名映射和索引设置

---

## 3. 核心逻辑设计

### 3.1 参数定义

```python
@dataclass
class LianbanAnalysisConfig:
    """连板分析配置"""
    
    # 必填参数
    start_date: str  # 开始日期，格式: YYYYMMDD
    end_date: str    # 结束日期，格式: YYYYMMDD
    
    # 筛选条件
    min_lianban_count: int = 3  # 最小连板数，默认3
    lianban_type: int = 1        # 连板类型：1=连续板，2=最高板，3=非连续板
    
    # 绘图范围（可配置的全局变量）
    before_days: int = 30    # 首板前显示的交易日数
    after_days: int = 10     # 终止后显示的交易日数
    end_threshold_days: int = 7  # 判断连板终止的阈值天数
    
    # 路径配置
    fupan_file: str = './excel/fupan_stocks.xlsx'
    data_dir: str = './data/astocks'
    output_dir: str = './analysis/lianban_charts'
```

### 3.2 连板类型判断逻辑

#### 类型1: 连续板
```python
# 条件: 连续涨停天数 >= min_lianban_count
# 特点: 无断板
is_continuous = (continuous_days >= min_count)
```

#### 类型2: 最高板
```python
# 条件: 从"几天几板"提取的板数 >= min_lianban_count
# 示例: "5天3板" -> 板数=3
max_board = extract_board_count_from_jitian_jiban(jitian_jiban_str)
is_max_board = (max_board >= min_count)
```

#### 类型3: 非连续板
```python
# 条件: (最高板数 >= min_count) AND (最高板数 != 连续涨停天数)
# 特点: 有断板
max_board = extract_board_count_from_jitian_jiban(jitian_jiban_str)
is_non_continuous = (max_board >= min_count) and (max_board != continuous_days)
```

### 3.3 首板日期识别

**定义**: 股票首次出现在【连板数据】中的日期

**识别逻辑**:
```python
def find_first_board_date(stock_code: str, date_columns: list, lianban_data: pd.DataFrame) -> str:
    """
    遍历所有日期列，找到该股票首次出现的日期
    """
    for date_col in sorted(date_columns):  # 按日期升序
        cell_value = lianban_data.loc[stock_code, date_col]
        if pd.notna(cell_value):  # 该日期有数据
            return date_col
    return None
```

**注意事项**:
- 首板不一定是"首板涨停"标记，可能直接是2板（如果前面的首板没被记录）
- 需要从最早的日期开始扫描

### 3.4 终止日期识别

**定义**: 股票最后一次出现在【连板数据】中的日期

**识别逻辑**:
```python
def find_end_date(stock_code: str, date_columns: list, lianban_data: pd.DataFrame, 
                  threshold_days: int = 7) -> str:
    """
    找到最后一次出现的日期
    验证: 之后至少连续 threshold_days 个交易日都不再出现
    """
    last_appear_date = None
    
    for date_col in sorted(date_columns, reverse=True):  # 按日期降序
        cell_value = lianban_data.loc[stock_code, date_col]
        if pd.notna(cell_value):
            last_appear_date = date_col
            break
    
    # 验证: 之后7个交易日内不再出现
    if last_appear_date:
        last_date_dt = parse_date_column(last_appear_date)
        # 获取之后的7个交易日
        future_trading_days = get_n_trading_days_after(last_date_dt, threshold_days)
        
        # 检查这些日期中是否还出现
        for future_date in future_trading_days:
            future_col = format_to_column_date(future_date)
            if future_col in date_columns:
                cell_value = lianban_data.loc[stock_code, future_col]
                if pd.notna(cell_value):
                    # 还有出现，继续向后找
                    return find_end_date(stock_code, [c for c in date_columns if c >= future_col], 
                                        lianban_data, threshold_days)
        
        return last_appear_date
    
    return None
```

**注意事项**:
- 需要考虑交易日的准确计数（使用 `utils/date_util.py` 中的函数）
- 终止日期可能不是跌停，可能是缓慢回调

### 3.5 绘图范围计算

```python
def calculate_chart_range(first_board_date: str, end_date: str, 
                         before_days: int = 30, after_days: int = 10) -> tuple:
    """
    计算K线图的起止日期
    
    Returns:
        (chart_start_date, chart_end_date) 均为 datetime 对象
    """
    # 首板日期往前推 before_days 个交易日
    first_board_dt = parse_date(first_board_date)
    chart_start = get_n_trading_days_before(first_board_dt, before_days)
    
    # 终止日期往后推 after_days 个交易日
    end_dt = parse_date(end_date)
    chart_end = get_n_trading_days_after(end_dt, after_days)
    
    return chart_start, chart_end
```

---

## 4. 核心类设计

### 4.1 LianbanAnalyzer 主类

```python
class LianbanAnalyzer:
    """连板股分析器"""
    
    def __init__(self, config: LianbanAnalysisConfig):
        self.config = config
        self.lianban_data = None  # 连板数据DataFrame
        self.filtered_stocks = []  # 筛选后的股票列表
        
    def load_lianban_data(self):
        """加载连板数据"""
        # 读取Excel
        # 解析日期列
        # 过滤日期范围
        
    def filter_stocks(self):
        """根据条件筛选股票"""
        # 遍历所有行
        # 对每只股票应用筛选条件
        # 返回符合条件的股票列表
        
    def analyze_single_stock(self, stock_code: str, stock_name: str):
        """分析单只股票"""
        # 识别首板日期
        # 识别终止日期
        # 计算绘图范围
        # 读取交易数据
        # 生成K线图
        
    def run(self):
        """执行完整分析流程"""
        # 1. 加载数据
        # 2. 筛选股票
        # 3. 批量分析
        # 4. 生成汇总报告
```

### 4.2 StockBoardInfo 数据类

```python
@dataclass
class StockBoardInfo:
    """连板股信息"""
    code: str              # 股票代码
    name: str              # 股票简称
    first_board_date: str  # 首板日期（YYYYMMDD）
    end_date: str          # 终止日期（YYYYMMDD）
    max_board_count: int   # 最高板数
    continuous_days: int   # 连续涨停天数
    board_type: str        # 连板类型描述
    all_dates: list        # 所有出现的日期列表（用于分析）
```

---

## 5. 绘图实现

### 5.1 使用现有的绘图工具

参考 `utils/backtrade/visualizer.py` 中的实现：
- 使用 `mplfinance` 库
- 红涨绿跌配色（中国A股风格）
- K线图 + 成交量副图

### 5.2 图表标注

在K线图上添加关键标记：
1. **首板标记**: 在首板日期K线上方显示 "首板" 标记（绿色向上三角）
2. **终止标记**: 在终止日期K线上方显示 "终止" 标记（红色向下三角）
3. **最高板标记**: 在达到最高板数的日期标注板数（如 "5板"）

### 5.3 图表标题

```
{股票代码} {股票名称} - 连板分析
首板: {首板日期} | 终止: {终止日期} | 最高: {max_board}板 | 连续: {continuous_days}天
类型: {连板类型}
```

### 5.4 文件命名

```python
filename = f"{stock_name}_{first_board_date}_{end_date}.png"
# 示例: 同花顺_20250101_20250115.png
```

---

## 6. 工具函数设计

### 6.1 日期解析函数

```python
def parse_column_date(column_date: str) -> datetime:
    """
    将Excel列名日期转为datetime
    输入: "2025年01月15日"
    输出: datetime(2025, 1, 15)
    """
    
def format_to_column_date(dt: datetime) -> str:
    """
    将datetime转为Excel列名格式
    输入: datetime(2025, 1, 15)
    输出: "2025年01月15日"
    """
```

### 6.2 连板数据解析

```python
def parse_lianban_cell(cell_value: str) -> dict:
    """
    解析连板数据单元格
    输入: "300033; 同花顺; 0; 09:25:03; 3天3板; 88.50; 09:25:03; 9.8%; 3; 软件"
    输出: {
        'code': '300033',
        'name': '同花顺',
        'kai_ban': 0,
        'final_zt_time': '09:25:03',
        'jitian_jiban': '3天3板',
        'price': 88.50,
        'first_zt_time': '09:25:03',
        'pct_chg': 9.8,
        'continuous_days': 3,
        'reason': '软件'
    }
    """
```

### 6.3 板数提取

```python
def extract_board_count(jitian_jiban: str) -> int:
    """
    从"几天几板"中提取板数
    输入: "3天3板" -> 3
    输入: "5天3板" -> 3
    输入: "首板涨停" -> 1
    """
    if jitian_jiban == "首板涨停":
        return 1
    
    match = re.search(r'(\d+)天(\d+)板', jitian_jiban)
    if match:
        return int(match.group(2))
    return 0
```

---

## 7. 实现步骤

### Phase 1: 数据读取与解析（核心基础）
1. 实现连板数据读取
2. 实现日期范围过滤
3. 实现单元格数据解析
4. 单元测试：验证数据解析正确性

### Phase 2: 股票筛选逻辑
1. 实现三种连板类型的判断逻辑
2. 实现最小连板数筛选
3. 实现首板日期识别
4. 实现终止日期识别
5. 单元测试：验证筛选逻辑

### Phase 3: 绘图功能
1. 复用现有的K线绘图代码
2. 添加连板特有的标记（首板、终止、最高板）
3. 实现批量绘图
4. 集成测试：生成示例图表

### Phase 4: 主流程集成
1. 整合所有模块
2. 添加进度显示
3. 添加异常处理
4. 生成汇总报告（CSV格式）

### Phase 5: main.py集成
1. 在main.py中添加调用函数
2. 编写使用文档
3. 提供配置示例

---

## 8. 输出说明

### 8.1 图表文件
**位置**: `analysis/lianban_charts/{日期范围}/`
- 示例: `analysis/lianban_charts/20250101_20250131/`

**命名**: `{股票名}_{首板日期}_{终止日期}.png`
- 示例: `同花顺_20250105_20250115.png`

### 8.2 汇总报告
**位置**: `analysis/lianban_charts/{日期范围}/summary.csv`

**内容**:
```csv
股票代码,股票名称,首板日期,终止日期,最高板数,连续天数,连板类型,图表路径
300033,同花顺,20250105,20250115,5,5,连续板,./同花顺_20250105_20250115.png
```

---

## 9. 调用示例

```python
# 在 main.py 中添加函数

def analyze_lianban_stocks(start_date='20250101', end_date='20250131',
                          min_lianban=3, lianban_type=1):
    """
    分析连板股票并生成K线图
    
    Args:
        start_date: 开始日期，格式YYYYMMDD
        end_date: 结束日期，格式YYYYMMDD
        min_lianban: 最小连板数，默认3
        lianban_type: 连板类型，1=连续板，2=最高板，3=非连续板
    """
    from analysis.lianban_analyzer import LianbanAnalyzer, LianbanAnalysisConfig
    
    config = LianbanAnalysisConfig(
        start_date=start_date,
        end_date=end_date,
        min_lianban_count=min_lianban,
        lianban_type=lianban_type,
        before_days=30,  # 可自定义
        after_days=10    # 可自定义
    )
    
    analyzer = LianbanAnalyzer(config)
    analyzer.run()
    
    print(f"分析完成！共生成 {len(analyzer.filtered_stocks)} 张图表")
    print(f"图表保存在: {analyzer.output_dir}")

# 使用示例
if __name__ == '__main__':
    # 分析1月份的连续3板以上的股票
    analyze_lianban_stocks('20250101', '20250131', min_lianban=3, lianban_type=1)
```

---

## 10. 注意事项

### 10.1 数据完整性
- 连板数据可能存在缺失（如停牌日期）
- 需要做好异常处理

### 10.2 性能优化
- 对于大批量股票（如100+），考虑：
  - 添加进度条（使用 `tqdm`）
  - 多进程并行绘图（参考 `bin/batch_backtester.py`）
  - 缓存交易数据

### 10.3 边界情况
- 首板日期在查询范围之前（需要回溯）
- 终止日期在查询范围之后（可能仍在连板中）
- 股票在数据范围内多次连板（需要分段处理）

### 10.4 扩展性
- 预留参数用于未来功能扩展：
  - 添加均线（如MA5, MA10, MA20）
  - 标注成交量异常
  - 计算收益率统计

---

## 11. 测试计划

### 11.1 单元测试
- `test_parse_lianban_cell()`: 测试单元格解析
- `test_extract_board_count()`: 测试板数提取
- `test_date_conversion()`: 测试日期转换

### 11.2 集成测试
- 使用小范围日期（如1周）测试完整流程
- 验证生成的图表正确性
- 检查汇总报告的准确性

### 11.3 回归测试
- 对比已知的连板股（如历史明星股）
- 验证筛选逻辑的准确性

---

## 12. 文档与使用

### 12.1 代码注释
- 所有公共函数添加docstring
- 复杂逻辑添加行内注释
- 关键算法添加示例

### 12.2 README
- 在 `analysis/` 目录下创建 `README_lianban.md`
- 包含功能说明、参数说明、使用示例

### 12.3 更新日志
- 在文档中记录版本变更
- 记录已知问题和TODO

---

## 附录A: 依赖的现有模块

| 模块 | 功能 | 位置 |
|------|------|------|
| `read_stock_data()` | 读取股票CSV数据 | `utils/backtrade/visualizer.py` |
| `_setup_mpf_style()` | K线图样式设置 | `utils/backtrade/visualizer.py` |
| `get_trading_days()` | 获取交易日列表 | `utils/date_util.py` |
| `get_n_trading_days_before()` | 往前推N个交易日 | `utils/date_util.py` |

---

## 附录B: 可参考的现有工具

| 工具 | 参考价值 |
|------|---------|
| `bin/scanner_analyzer.py` | 批量股票分析流程 |
| `bin/comparison_chart_generator.py` | 批量生成对比图 |
| `utils/backtrade/selection_review_visualizer.py` | K线标记和回顾逻辑 |
| `analysis/ladder_chart.py` | 处理连板数据的示例 |

---

**文档版本**: v1.0  
**创建日期**: 2025-10-29  
**最后更新**: 2025-10-29  
**作者**: AI Assistant 