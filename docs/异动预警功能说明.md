# 异动预警功能说明

## 功能概述

异动预警功能已成功集成到天梯图中，能够自动检测股票的异常波动和严重异常波动，并在天梯图的最右侧添加预警列，帮助用户及时识别风险。

## 监管规则

### 1. 异常波动标准
- **连续3个交易日内日收盘价格涨跌幅偏离值累计达到±20%**
- **或连续3个交易日内日均换手率与前5个交易日的日均换手率的比值达到30倍且累计换手率达到20%**

### 2. 严重异常波动标准
- **10个交易日内累计偏离值达到100%(-50%)**
- **或30个交易日内累计偏离值达到200%(-70%)**

### 3. 偏离值计算
- **偏离值 = 个股涨幅 - 对应市场指数涨幅**
- 主板股票使用上证指数
- 创业板股票使用创业板指数
- 科创板股票使用上证指数
- 北交所股票使用上证指数

## 预警显示

### 预警列位置
- 位于天梯图所有日期列的最右侧
- 列标题为"异动预警"
- 列宽自动调整为20个字符宽度

### 预警颜色说明
- 🔴 **红色背景 + 白色粗体字**：已触发严重异常波动
- 🟠 **橙色背景 + 白色粗体字**：已触发异常波动
- 🟡 **金色背景**：即将触发严重异动（距离触发≤30%）
- 🟨 **浅黄背景**：即将触发异常波动（距离触发≤15%）
- ⚪ **无背景**：正常状态

### 预警信息示例
- `已触发严重异常波动(10日偏离值): 10日累计偏离值105.23%`
- `已触发异常波动(偏离值): 3日累计偏离值22.45%`
- `上涨15.2%将触发严重异动(10日)`
- `下跌8.5%将触发异常波动`

## 使用方法

### 1. 生成带预警的天梯图
```python
from analysis.ladder_chart import build_ladder_chart

# 调用天梯图生成函数（预警功能默认开启）
result = build_ladder_chart(
    start_date='20250825',
    end_date='20250905',
    output_file='./output/ladder_chart_with_warning.xlsx'
)
```

### 2. 独立使用异动检测器
```python
from analysis.abnormal_movement_detector import AbnormalMovementDetector

# 创建检测器实例
detector = AbnormalMovementDetector()

# 检查单只股票
warning_message = detector.get_warning_message('000001', '20250905')
print(warning_message)

# 综合分析
result = detector.analyze_stock('000001', '20250905')
print(result)
```

## 技术特点

### 1. 高性能设计
- 使用缓存机制避免重复读取数据
- 批量处理提高效率
- 智能的市场指数匹配

### 2. 准确性保证
- 严格按照监管规则实现
- 自动处理交易日对齐
- 支持多市场指数匹配

### 3. 用户友好
- 直观的颜色编码
- 详细的预警信息
- 无缝集成到现有工作流

## 文件结构

```
analysis/
├── abnormal_movement_detector.py  # 异动检测器核心模块
├── ladder_chart.py               # 天梯图生成器（已集成预警功能）
└── ...

test_abnormal_movement.py         # 异动检测器测试脚本
test_ladder_chart_with_warning.py # 天梯图预警功能测试脚本
```

## 注意事项

1. **数据依赖**：需要确保股票数据和指数数据文件存在且格式正确
2. **日期格式**：支持 YYYY-MM-DD 和 YYYYMMDD 两种日期格式
3. **市场匹配**：自动根据股票代码识别所属市场并匹配对应指数
4. **性能考虑**：首次运行时会初始化指数数据缓存，后续运行速度更快

## 更新日志

- **2025-09-06**：完成异动预警功能开发和集成
- 支持异常波动和严重异常波动检测
- 集成到天梯图的两个工作表中
- 添加直观的颜色编码和详细预警信息

## 支持

如有问题或建议，请联系开发团队。

---

**支付宝到账一百万元** 🎉
