# 从复盘数据提取批量回测候选股

## 功能说明

从 `excel/fupan_stocks.xlsx` 复盘数据文件中提取特定类型的热门股，作为批量回测的候选股票池。

相比全市场5000只股票，这种方式可以：
- **聚焦热门股**：只回测曾经活跃的股票
- **提高效率**：大幅减少回测数量
- **针对性验证**：验证策略在强势股上的表现

---

## 可用的Sheet类型

根据 `fupan.py` 的定义，支持以下sheet类型：

| Sheet名称 | 说明 | 适用场景 |
|----------|------|---------|
| 连板数据 | 连续涨停的股票 | 验证策略对连板股的把握能力 |
| 首板数据 | 首次涨停的股票 | 验证首板打板策略 |
| 炸板数据 | 涨停后打开的股票 | 验证炸板后反包策略 |
| 反包数据 | 低开后大幅拉升的股票 | 验证反包策略 |
| 大涨数据 | 涨幅>9%的股票 | 验证对强势股的追踪 |
| 大跌数据 | 跌幅>9%的股票 | 验证抄底或避险能力 |
| 跌停数据 | 跌停的股票 | 验证极端行情处理 |
| 关注度榜 | 热度最高的股票 | 验证热点股策略 |
| 默默上涨 | 温和上涨的股票 | 验证趋势跟踪策略 |

---

## 使用方法

### 方式1：在 main.py 中调用

```python
if __name__ == '__main__':
    # 打开注释运行
    generate_fupan_candidates()
```

### 方式2：直接调用函数

```python
from bin.generate_stock_list import generate_fupan_stock_list

# 提取2025年1月的连板股
generate_fupan_stock_list(
    sheet_names=['连板数据'],
    start_date='20250101',
    end_date='20250131',
    output_prefix='lianban_202501'
)
```

---

## 使用示例

### 示例1：提取连板股（单一类型）

```python
generate_fupan_stock_list(
    sheet_names=['连板数据'],
    start_date='20250101',
    end_date='20250131',
    output_prefix='lianban_202501'
)
```

输出文件：
- `data/batch_backtest/lianban_202501_20250101_20250131.txt`
- `data/batch_backtest/lianban_202501_20250101_20250131.csv`

### 示例2：提取多种类型热门股

```python
generate_fupan_stock_list(
    sheet_names=['连板数据', '首板数据', '大涨数据'],
    start_date='20250101',
    end_date='20250131',
    output_prefix='hot_stocks_202501'
)
```

这会提取1月份所有连板、首板、大涨的股票（自动去重）。

### 示例3：提取所有类型（不限日期）

```python
generate_fupan_stock_list(
    sheet_names=None,  # None表示所有sheet
    start_date=None,   # None表示从最早开始
    end_date=None,     # None表示到最晚
    output_prefix='all_fupan_stocks'
)
```

### 示例4：提取最近的热门股

```python
from datetime import datetime, timedelta

# 最近30天
end_date = datetime.now().strftime('%Y%m%d')
start_date = (datetime.now() - timedelta(days=30)).strftime('%Y%m%d')

generate_fupan_stock_list(
    sheet_names=['连板数据', '首板数据'],
    start_date=start_date,
    end_date=end_date,
    output_prefix='recent_30days'
)
```

---

## 完整工作流程

### Step 1: 提取候选股

```python
# 在 main.py 中
generate_fupan_candidates()
```

运行后在 `data/batch_backtest/` 生成股票列表文件。

### Step 2: 批量回测

修改 `batch_backtest_from_stock_list()` 函数：

```python
def batch_backtest_from_stock_list():
    stock_list_file = 'data/batch_backtest/lianban_202501_20250101_20250131.txt'
    
    report_path = batch_backtest_from_file(
        stock_list_file=stock_list_file,
        strategy_class=BreakoutStrategyV2,
        strategy_params={'debug': False},
        startdate=datetime(2022, 1, 1),
        enddate=datetime(2025, 10, 21),
        amount=100000,
        max_workers=6
    )
```

### Step 3: 查看结果

在 `bin/batch_backtest_results/` 目录查看生成的Excel报告。

---

## 参数说明

### `generate_fupan_stock_list()` 参数

| 参数 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| fupan_file | str | 复盘数据文件路径 | `'excel/fupan_stocks.xlsx'` |
| sheet_names | List[str] | 要提取的sheet列表 | `None`（所有sheet） |
| start_date | str | 开始日期，格式'YYYYMMDD' | `None`（最早） |
| end_date | str | 结束日期，格式'YYYYMMDD' | `None`（最晚） |
| output_dir | str | 输出目录 | `'data/batch_backtest'` |
| output_prefix | str | 输出文件名前缀 | `'fupan_stocks'` |

---

## 测试验证

运行测试脚本验证功能：

```bash
conda activate trading

# 快速测试（提取连板数据）
python tests/test_fupan_extraction.py --test lianban

# 测试多种类型
python tests/test_fupan_extraction.py --test multiple

# 完整测试
python tests/test_fupan_extraction.py --test full
```

---

## 实际应用场景

### 场景1：验证打板策略

```python
# 提取连板股
generate_fupan_stock_list(
    sheet_names=['连板数据'],
    start_date='20240101',
    end_date='20241231',
    output_prefix='lianban_2024'
)

# 用打板策略回测
batch_backtest_from_file(
    stock_list_file='data/batch_backtest/lianban_2024_20240101_20241231.txt',
    strategy_class=BreakoutStrategy,
    max_workers=6
)
```

### 场景2：对比不同时期的市场表现

```python
# 提取Q1的热门股
generate_fupan_stock_list(
    sheet_names=['连板数据', '首板数据'],
    start_date='20250101',
    end_date='20250331',
    output_prefix='hot_q1'
)

# 提取Q2的热门股
generate_fupan_stock_list(
    sheet_names=['连板数据', '首板数据'],
    start_date='20250401',
    end_date='20250630',
    output_prefix='hot_q2'
)

# 分别回测对比
```

### 场景3：筛选特定行情下的股票

```python
# 只提取大涨+炸板股（波动大的股票）
generate_fupan_stock_list(
    sheet_names=['大涨数据', '炸板数据'],
    start_date='20250101',
    output_prefix='volatile_stocks'
)
```

---

## 注意事项

1. **数据文件路径**：确保 `excel/fupan_stocks.xlsx` 文件存在且有数据
2. **Sheet名称**：必须与复盘文件中的sheet名称完全一致
3. **日期格式**：使用 `YYYYMMDD` 格式，如 `'20250101'`
4. **自动去重**：同一只股票在不同日期/不同sheet中出现，只保留一次
5. **股票代码验证**：只提取6位数字的有效股票代码

---

## 常见问题

### Q1: 提取的股票数量为0？

**可能原因**：
- 日期范围内没有数据
- Sheet名称拼写错误
- 复盘文件路径不正确

**解决方法**：
- 检查日期范围是否正确
- 检查sheet名称（区分大小写）
- 确认 `excel/fupan_stocks.xlsx` 存在

### Q2: 如何查看可用的Sheet名称？

```python
import pandas as pd
excel_file = pd.ExcelFile('excel/fupan_stocks.xlsx')
print("可用的Sheet:", excel_file.sheet_names)
```

### Q3: 提取出的股票太多/太少？

**调整策略**：
- 太多：缩小日期范围，减少sheet类型
- 太少：扩大日期范围，增加sheet类型

---

## 优势对比

| 对比项 | 全市场回测 | 复盘数据提取 |
|--------|-----------|------------|
| 股票数量 | ~5000只 | 50-500只（可调） |
| 回测耗时 | 1-2小时 | 5-15分钟 |
| 针对性 | 低 | **高** |
| 适用场景 | 全面验证 | **快速验证强势股** |

---

**推荐工作流程**：
1. 先用复盘数据提取热门股快速验证策略
2. 如果效果好，再用全市场数据全面验证
3. 结合两者结果，优化策略参数

---

祝回测顺利！🚀 