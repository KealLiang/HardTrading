# 低优先级原因列表功能说明

## 功能概述

新增 `low_priority_reasons` 参数，用于定义股票分组时的低优先级题材概念。当股票同时匹配多个分组时，低优先级分组将被排在最后考虑，只有在没有其他可匹配分组时才会被选择。

## 使用场景

适用于某些概念过于宽泛或不够具体的情况。例如"预期改善"这个概念，如果一只股票同时有"预期改善"和其他更具体的题材（如"大金融"、"AI应用"等），我们希望股票归入更具体的题材，而不是"预期改善"。

## 使用方法

### 1. 在 main.py 中配置

```python
def generate_ladder_chart():
    # ... 其他配置 ...
    
    # 定义高优先原因列表
    priority_reasons = [
        # "创新药"
    ]
    
    # 定义低优先原因列表（只有在没有其他分组可匹配时才使用）
    low_priority_reasons = [
        "预期改善"  # 可以添加多个低优先级概念
    ]

    # 构建梯队图
    build_ladder_chart(
        start_date, end_date, 
        min_board_level=min_board_level,
        non_main_board_level=non_main_board_level, 
        show_period_change=show_period_change,
        priority_reasons=priority_reasons,
        low_priority_reasons=low_priority_reasons,  # 传递低优先级列表
        enable_attention_criteria=True,
        sheet_name=sheet_name, 
        create_leader_sheet=True, 
        create_volume_sheet=True
    )
```

### 2. 命令行使用

```bash
python analysis/ladder_chart.py \
  --start_date 20250901 \
  --end_date 20251101 \
  --priority_reasons "创新药,算力产业" \
  --low_priority_reasons "预期改善" \
  --show_period_change \
  --create_leader_sheet
```

## 分组优先级规则

股票分组时的完整优先级规则如下：

1. **低优先级标志**：非低优先级 > 低优先级（最高优先级）
2. **匹配类型**：精确匹配 > 模糊匹配
3. **出现次数**：在该股票内出现次数多的优先
4. **热门度**：全市场热门度高的优先（top_reasons排名）

## 示例说明

### 示例1：股票有多个分组

假设一只股票有以下题材：
- "预期改善"（精确匹配）
- "大金融"（模糊匹配）

**不使用低优先级列表时**：
- 股票归入"预期改善"（因为是精确匹配，优先级更高）

**使用低优先级列表 `["预期改善"]` 时**：
- 股票归入"大金融"（因为"预期改善"是低优先级，即使是精确匹配也排在后面）

### 示例2：股票只有低优先级分组

假设一只股票只有以下题材：
- "预期改善"

**使用低优先级列表 `["预期改善"]` 时**：
- 股票仍然归入"预期改善"（因为没有其他可选分组）

## 向后兼容性

如果 `low_priority_reasons` 参数传入 `None` 或空列表 `[]`，则逻辑与之前完全一致，不会影响现有功能。

```python
# 以下两种调用方式效果相同（向后兼容）
build_ladder_chart(..., low_priority_reasons=None)
build_ladder_chart(..., low_priority_reasons=[])
build_ladder_chart(...)  # 不传参数，默认为None
```

## 技术实现

### 修改的文件

1. **utils/theme_color_util.py**
   - `get_reason_colors()`: 添加 `low_priority_reasons` 参数，低优先级原因排在热门原因列表末尾
   - `get_stock_reason_group()`: 添加低优先级判断逻辑，确保低优先级原因排在最后

2. **analysis/ladder_chart.py**
   - `build_ladder_chart()`: 添加 `low_priority_reasons` 参数
   - `prepare_stock_data()`: 传递 `low_priority_reasons` 参数
   - `identify_first_significant_board()`: 传递 `low_priority_reasons` 参数
   - `identify_significant_boards()`: 传递 `low_priority_reasons` 参数
   - `get_cached_concept_group()`: 添加 `low_priority_reasons_str` 参数
   - 命令行参数解析：添加 `--low_priority_reasons` 参数

3. **main.py**
   - `generate_ladder_chart()`: 添加 `low_priority_reasons` 配置

### 核心逻辑

在 `get_stock_reason_group()` 函数中，对每只股票的原因进行评分排序时：

```python
# 排序键：(是否低优先级, -匹配分数, -出现次数, 热门度排名)
scored_reasons.sort(key=lambda x: (
    x['is_low_priority'],      # False排在前（非低优先级），True排在后（低优先级）
    -x['match_score'],         # 匹配类型分数越高越靠前
    -x['count'],               # 出现次数越多越靠前
    x['top_rank']              # 热门度排名越小越靠前
))
```

通过在排序键中首先判断 `is_low_priority`，确保低优先级原因排在所有非低优先级原因之后，无论其匹配类型、出现次数或热门度如何。

## 测试验证

已创建测试脚本 `tests/test_low_priority_reasons.py`，验证以下场景：

1. ✅ 不使用低优先级列表时的行为（向后兼容）
2. ✅ 使用低优先级列表后，热门原因列表的顺序
3. ✅ 股票有多个分组时，避开低优先级分组
4. ✅ 股票只有低优先级分组时，仍然归入该分组

运行测试：
```bash
conda activate trading
python tests/test_low_priority_reasons.py
```

## 常见问题

**Q: 如果我不想使用这个功能怎么办？**
A: 不传参数或传 `None`/`[]` 即可，不会影响现有逻辑。

**Q: 可以同时使用高优先级和低优先级列表吗？**
A: 可以，分组优先级为：高优先级 > 普通分组 > 低优先级 > "其他"

**Q: 低优先级列表中的概念会从Excel中消失吗？**
A: 不会。低优先级概念仍然会出现在Excel的"题材概念"列中，只是在分组时优先级降低。如果股票没有其他可选分组，仍然会归入低优先级分组。

**Q: 如果一只股票有多个低优先级概念，如何选择？**
A: 按照原有的优先级规则（匹配类型 > 出现次数 > 热门度）选择。

## 更新日期

2025年12月1日 