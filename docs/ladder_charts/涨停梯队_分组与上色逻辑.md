# 涨停梯队 - 分组与上色逻辑

## 概念匹配类型

题材概念与同义词字典匹配时分为三种类型：

- **精确匹配 (exact)**: 原始概念词完全匹配字典中的词（如："商业航天" → "商业航天"）
- **模糊匹配 (fuzzy)**: 通过通配符匹配（如："氢能装备" 通过 `%氢%` → "核聚变"）
- **未匹配 (unmatched)**: 无法归类到已知分组（如："液力传动" → "未分类_液力传动"）

> 相关代码：[`utils/theme_color_util.py`](../../utils/theme_color_util.py) - `get_reason_match_type()`, `normalize_reason()`

## 核心原则

**匹配类型优先级 > 热门度**

这意味着：
- 精确匹配的非热门概念 > 模糊匹配的热门概念
- 例如："商业航天"（精确，非热门）会优先于"核聚变"（模糊，热门）

---

## 上色逻辑

**位置**：【涨停梯队】sheet 的概念列（第2列）

**逻辑**：
1. 使用 `get_stock_reason_group()` 为每只股票确定主概念组
2. 优先级规则：
   - **匹配类型**：精确 > 模糊（最高优先级）
   - **出现次数**：该概念在该股票内出现次数
   - **热门度**：全市场该概念的出现频率
3. 主概念组在热门概念列表中时，应用对应颜色
4. 非热门概念不上色

**示例**：
```
股票: 航天动力
概念: 商业航天+氢能装备+液力传动+央企
规范化: 商业航天(精确) + 核聚变(模糊) + 未分类_液力传动 + 国企(模糊)
主概念组: 商业航天 (精确匹配优先)
颜色: 无色（商业航天不在热门列表中）
```

> 相关代码：
> - [`utils/theme_color_util.py`](../../utils/theme_color_util.py) - `get_stock_reason_group()`
> - [`analysis/ladder_chart.py`](../../analysis/ladder_chart.py) - `format_concept_cell()`

---

## 分组逻辑

**位置**：【涨停梯队_概念分组】sheet

**逻辑**：
1. 使用 `get_global_concept_group()` 为每只股票确定分组
2. 优先级规则（与上色相同的核心原则）：
   - **精确匹配的概念** （优先级最高）
     - 1a. 精确匹配 + 热门概念
     - 1b. 精确匹配 + 非热门概念
   - **模糊匹配的概念** （只有无精确匹配时才考虑）
     - 2a. 模糊匹配 + 热门概念
     - 2b. 模糊匹配 + 非热门概念
3. 按分组名称排序后，在sheet中展示

**示例**：
```
股票: 航天动力
概念: 商业航天+氢能装备+液力传动+央企
热门概念: [算力产业, 电池储能, 机器人, AI应用, 大基建, 核聚变, ...]
分组: 【商业航天】（步骤1b: 精确匹配，虽非热门但优先级高于模糊匹配的"核聚变"）
```

> 相关代码：
> - [`analysis/ladder_chart.py`](../../analysis/ladder_chart.py) - `get_global_concept_group()` (第1015-1068行)
> - [`analysis/ladder_chart.py`](../../analysis/ladder_chart.py) - `create_concept_grouped_sheet_content()`

---

## 上色 vs 分组

| 维度 | 上色 | 分组 |
|------|------|------|
| **用途** | 视觉标记热门概念 | 将股票归类到不同组 |
| **位置** | 【涨停梯队】sheet | 【涨停梯队_概念分组】sheet |
| **核心函数** | `get_stock_reason_group()` | `get_global_concept_group()` |
| **优先级规则** | 匹配类型 > 出现次数 > 热门度 | 匹配类型 > 热门度 |
| **是否上色** | 只有热门概念才上色 | 所有分组都显示（不管是否热门） |

**关键差异**：
- 上色需要概念在热门列表中才会显示颜色
- 分组不管是否热门都会分配到对应组
- 因此可能出现"无色但有分组"的情况（如航天动力分到商业航天组但无色）

---

## 同义词配置

同义词字典定义了概念的匹配规则：

**文件**：[`data/reasons/origin_synonym_groups.py`](../../data/reasons/origin_synonym_groups.py)

**格式示例**：
```python
synonym_groups = {
    "商业航天": ["商业航天", "宇航产品", "%火箭%", "卫星互联网"],
    "核聚变": ["%氢%", "%核聚变%", "%核电%", "%核能%", "超导"],
}
```

**规则**：
- 不带 `%` 的词：精确匹配（如："商业航天"）
- 带 `%` 的词：模糊匹配（如：`%氢%` 可匹配"氢能装备"、"氢气"等）

---

## 测试验证

使用 [`tests/test_stock_grouping.py`](../../tests/test_stock_grouping.py) 快速验证股票的分组逻辑：

```bash
# 测试特定股票的分组
python tests/test_stock_grouping.py
```

会输出完整的分组过程，包括：
- 概念提取与规范化
- 匹配类型判断
- 热门概念列表
- 分组决策过程 