# 涨停梯队 - 分组与上色逻辑

## 核心优先级规则

**完整优先级（从高到低）**：

| 优先级 | 维度                         | 说明                                                                                                      |
|-----|----------------------------|---------------------------------------------------------------------------------------------------------|
| 1️⃣ | **`low_priority_reasons`** | 不在低优先级列表中的概念优先                                                                                          |
| 2️⃣ | **匹配类型**                   | `exact` (精确) > `fuzzy` (模糊)                                                                             |
| 3️⃣ | **出现次数**                   | 该概念在该股票内出现次数（多 > 少）                                                                                     |
| 4️⃣ | **热门度排名**                  | `top_reasons` 中的排名（小 > 大）<br>**受 `priority_reasons` 影响**：`priority_reasons` 中的概念会强制排在 `top_reasons` 最前面 |

**核心原则**：**匹配类型 > 热门度**

- 精确匹配的非热门概念 > 模糊匹配的热门概念
- 例如："商业航天"（精确，非热门）会优先于"算力产业"（模糊，热门）

---

## 上色 vs 分组

| 维度                        | 上色                                           | 分组                                        |
|---------------------------|----------------------------------------------|-------------------------------------------|
| **位置**                    | 【涨停梯队】sheet 第2列                              | 【涨停梯队_概念分组】sheet                          |
| **执行顺序**                  | 后执行（在分组之后）                                   | 先执行（在识别显著连板时）                             |
| **核心函数**                  | `get_stock_reason_group()`                   | `select_concept_group_for_stock()`        |
| **优先级规则**                 | `low_priority_reasons` → 匹配类型 → 出现次数 → 热门度排名 | `low_priority_reasons` → 匹配类型 → 热门度（遍历顺序） |
| **是否上色**                  | 只有热门概念才上色                                    | 所有分组都显示（不管是否热门）                           |
| **数据来源**                  | `stock_reason_group`                         | `concept_group`                           |
| **`priority_reasons` 影响** | 影响 `top_reasons` 排序，进而影响热门度排名                | 影响 `top_reasons` 遍历顺序，优先被选中               |

**关键细节**：

- 上色需要概念在 `top_reasons` 列表中才会显示颜色
- 分组不管是否热门都会分配到对应组
- 可能出现"无色但有分组"的情况
- **`priority_reasons`**：手动指定当日重点关注的概念，会强制排在 `top_reasons` 最前面（无论出现次数），从而影响热门度排名和分组选择
- **`low_priority_reasons`**：只有在没有其他可匹配分组时才使用，优先级最低

---

## 出现次数详解

**出现次数**：统计同一个规范化概念在该股票中出现的次数。

**示例1：出现次数影响排序**

```
股票概念: [光通信芯片+光模块+商业航天]
匹配结果:
  - 光通信芯片 → 算力产业 (exact)
  - 光模块 → 算力产业 (exact)
  - 商业航天 → 商业航天 (exact)

统计:
  - 算力产业: count=2 (出现2次)
  - 商业航天: count=1 (出现1次)

排序结果: 算力产业优先（因为count更多）
```

**示例2：匹配类型优先级高于出现次数**

```
股票概念: [光通信芯片+光模块+商业航天]
匹配结果:
  - 光通信芯片 → 算力产业 (fuzzy)  # 假设通过%芯片%匹配
  - 光模块 → 算力产业 (fuzzy)
  - 商业航天 → 商业航天 (exact)

统计:
  - 算力产业: count=2, match_score=1 (fuzzy)
  - 商业航天: count=1, match_score=2 (exact)

排序结果: 商业航天优先（匹配类型优先级更高，即使count更少）
```

---

## 匹配类型

| 类型                  | 说明                 | 示例                                             |
|---------------------|--------------------|------------------------------------------------|
| **精确匹配 (exact)**    | 不带 `%` 的同义词，使用包含匹配 | "商业航天" → "商业航天"<br>"光通信芯片" → "算力产业"（因为包含"光通信"） |
| **模糊匹配 (fuzzy)**    | 带 `%` 的同义词，使用正则匹配  | "氢能装备" 通过 `%氢%` → "核聚变"                        |
| **未匹配 (unmatched)** | 无法归类               | "液力传动" → "未分类_液力传动"                            |

> **注意**：精确匹配使用的是**包含匹配**（`synonym in original_reason`），所以"光通信芯片"会被"光通信"匹配为精确匹配。

---

## 完整示例

**股票**：长光华芯  
**概念**：`[光通信芯片+商业航天+扭亏]`

**匹配过程**：

- `光通信芯片` → 匹配"光通信"（无%）→ `算力产业` (exact, count=1)
- `商业航天` → 匹配"商业航天"（无%）→ `商业航天` (exact, count=1)
- `扭亏` → 无匹配 → `未分类_扭亏` (unmatched)

**分组决策**（两者都是exact，count都是1，取决于热门度排名）：

- **情况1**：`priority_reasons = ["商业航天"]`
    - `top_reasons = ["商业航天", "算力产业", ...]`
    - 商业航天 `top_rank = 0`，算力产业 `top_rank = 1`
    - **结果**：分组和上色都是"商业航天" ✅

- **情况2**：`priority_reasons = ["算力产业"]`
    - `top_reasons = ["算力产业", "商业航天", ...]`
    - 算力产业 `top_rank = 0`，商业航天 `top_rank = 1`
    - **结果**：分组和上色都是"算力产业" ✅

- **情况3**：`priority_reasons = []` 或 `None`
    - `top_reasons = [按出现次数排序]`
    - 如果两者出现次数相同，按 `synonym_groups` 字典顺序
    - **结果**：取决于出现次数和字典顺序

---

## 相关代码

- **匹配类型判定
  **：[`utils/theme_color_util.py`](../../utils/theme_color_util.py) - `get_reason_match_type()`, `normalize_reason()`
- **上色逻辑**：[`utils/theme_color_util.py`](../../utils/theme_color_util.py) - `get_stock_reason_group()`
- **分组逻辑**：[`analysis/ladder_chart.py`](../../analysis/ladder_chart.py) - `select_concept_group_for_stock()`
- **热门度排序**：[`utils/theme_color_util.py`](../../utils/theme_color_util.py) - `get_reason_colors()`
- **同义词配置**：[`data/reasons/origin_synonym_groups.py`](../../data/reasons/origin_synonym_groups.py)