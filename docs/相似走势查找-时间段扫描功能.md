# 相似走势查找 - 时间段扫描功能说明

## 🎯 功能概述

支持在历史时间段内滑动窗口查找相似走势，而不是仅限于单一结束日期。这样可以找到历史上任意时期与目标股票走势相似的案例，更好地评估未来发展。

## 📝 使用方式

### 模式1：单一结束日期（原有功能）

适合：**已知某个时点，查找该时点的相似走势**

```python
find_other_similar_trends(
    target_stock_code='601212',
    start_date='20250815',  # 目标走势的起始日期
    end_date='20251014',    # 目标走势的结束日期
    stock_codes=None,
    data_dir='./data/astocks',
    method='enhanced_weighted',
    trend_end_date='20241231',  # 被查找股票的结束日期（单一时点）
    same_market=True
)
```

### 模式2：时间段扫描（新增功能）⭐

适合：**在历史任意时期查找相似走势，评估未来发展**

```python
find_other_similar_trends(
    target_stock_code='601212',
    start_date='20250815',  # 目标走势：2025年8月15日到10月14日
    end_date='20251014',
    stock_codes=None,
    data_dir='./data/astocks',
    method='enhanced_weighted',
    trend_date_range=('20200101', '20241231'),  # 在2020-2024年内滑动窗口查找
    search_step=None,  # None=自动使用window_size（不重叠窗口）
    same_market=True
)
```

## ⚙️ 参数说明

| 参数 | 类型 | 说明 |
|-----|------|------|
| `trend_end_date` | str/datetime/None | 单一结束日期（模式1） |
| `trend_date_range` | tuple/list/None | 时间段 `('起始', '结束')`（模式2，优先级更高） |
| `search_step` | int/None | 滑动步长，仅模式2有效 |

### search_step 参数详解

- **`None`（默认）**：自动使用 `window_size`，窗口不重叠 ⭐**强烈推荐**
  - 性能最优，计算量最小
  - **不会遗漏重要时期**（完整覆盖整个时间段）
  - 适合大范围历史扫描
  
- **自定义步长**（如 `10`、`20`）：每N个交易日采样一次
  - 步长越小，采样越密集，计算量越大
  - 步长越大，采样越稀疏，⚠️**可能错过高相似度的时期**
  
### ⚠️ 重要提示：步长对结果的影响

**问题场景**：
- 使用单一日期 `trend_end_date='20251014'` 能找到相似度 0.6+ 的股票
- 但使用时间段 `trend_date_range=('20250716', '20251016')` + `search_step=20` 只能找到 0.56

**原因分析**：
```
时间段包含60个交易日 (0-59)
目标窗口大小 = 40天

search_step=20 时:
  只扫描: [0-39], [20-59] 两个窗口
  如果最相似的窗口是 [14-53]，就会被跳过！
  
search_step=None 时:
  扫描: [0-39], [40-79], ... (不重叠窗口)
  完整覆盖，不会遗漏

search_step=1 时:
  扫描: [0-39], [1-40], [2-41], ... 
  最密集，但计算量×60倍
```

**建议**：
- ✅ 默认使用 `search_step=None`（不重叠窗口）
- ✅ 如果需要更密集采样，设置 `search_step=1` 或 `search_step=5`
- ❌ 避免使用较大步长（如20），除非只是快速预览

## 📊 性能评估

### 计算量对比

假设：5000只股票，目标窗口60天，历史5年(1200交易日)

| 模式 | 计算量 | 耗时估算 |
|-----|-------|---------|
| 单一日期 | 5,000次 | 1分钟 |
| 时间段(step=60) | 10万次 | 20分钟 |
| 时间段(step=20) | 30万次 | 1小时 |
| 时间段(step=1) | 600万次 | 10小时+ ⚠️ |

### 性能优化建议

1. **首选不重叠窗口**：`search_step=None`
   - 计算量合理，不会遗漏重要时期
   
2. **缩小股票范围**：先用快速方法筛选候选股
   ```python
   # 第一阶段：快速筛选
   find_other_similar_trends(..., method='weighted', stock_codes=all_stocks)
   
   # 第二阶段：精确扫描TOP候选
   find_other_similar_trends(
       ..., 
       method='enhanced_weighted',
       stock_codes=top_200_stocks,
       trend_date_range=('20200101', '20241231')
   )
   ```

3. **缩小时间范围**：根据实际需求限制历史时间段
   ```python
   # 只看最近3年
   trend_date_range=('20220101', '20241231')
   ```

## 🎨 结果说明

### 控制台日志输出

时间段扫描模式下，日志会显示历史时期信息：

```
股票代码: 600928, 历史时期: 2023-12-15, 相似度: 0.8523
股票代码: 601319, 历史时期: 2022-08-30, 相似度: 0.8301
```

单一日期模式下，只显示股票代码和相似度：

```
股票代码: 600928, 相似度: 0.8523
股票代码: 601319, 相似度: 0.8301
```

### K线图文件名

时间段扫描模式：`{股票名称}_{股票代码}_{窗口结束日期}_{相似度}_kline.png`

例如：`中国石化_600028_20231215_0.8523_kline.png`

单一日期模式：`{股票名称}_{股票代码}_{相似度}_kline.png`

例如：`中国石化_600028_0.8523_kline.png`

## 💡 使用建议

### 场景1：快速验证（推荐新手）
```python
# 只看最近1年 + 不重叠窗口
trend_date_range=('20240101', '20241231')
search_step=None
```

### 场景2：全面分析（推荐进阶）
```python
# 看5年历史 + 不重叠窗口
trend_date_range=('20200101', '20241231')
search_step=None
```

### 场景3：精密扫描（性能要求高）
```python
# 看3年 + 高密度采样
trend_date_range=('20220101', '20241231')
search_step=10  # 每10天采样
```

## ⚠️ 注意事项

1. **时间段越长，计算量越大**：建议先从短时间段试验
2. **步长越小，越耗时**：默认不重叠已足够
3. **关注日志提示**：会显示实际计算的窗口数量
4. **结果数量激增**：时间段模式会产生更多候选结果

## 🔧 故障排查

### Q: 计算太慢怎么办？
A: 
1. 增大 `search_step`
2. 缩短 `trend_date_range`
3. 限制 `stock_codes` 范围
4. 先用 `method='weighted'` 粗筛

### Q: 没有找到合适的相似走势？
A:
1. 扩大 `trend_date_range`
2. 减小 `search_step`（增加采样密度）
3. 尝试不同的 `method`
4. 取消 `same_market` 限制

### Q: 结果太多，难以分析？
A: 查看TOP 10即可，或调整相似度阈值（需修改代码） 