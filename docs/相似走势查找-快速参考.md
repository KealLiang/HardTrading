# 相似走势查找 - 快速参考

## 🚀 快速开始

### 基础用法（推荐配置）

```python
from datetime import datetime
from analysis.seek_historical_similar import find_other_similar_trends

# 中等规模查找（最常用）
find_other_similar_trends(
    target_stock_code="301308",
    start_date=datetime(2025, 9, 1),
    end_date=datetime(2025, 9, 29),
    stock_codes=None,  # 自动扫描所有
    data_dir="./data/astocks",
    method="enhanced_weighted",  # 🔥 推荐：增强版方法
    trend_end_date=datetime(2025, 9, 29),
    same_market=True,
    use_prefilter=True   # 智能预筛选（候选>100时建议开启）
)
```

## 📋 参数速查表

| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| `method` | `"enhanced_weighted"` | 相似度算法：考虑量价配合 |
| `use_prefilter` | `True` | 预筛选（候选>100时建议开启） |
| `same_market` | `True`/`False` | 是否限制同市场 |
| `trend_end_date` | `None`或日期 | 是否查找不同时段相似走势 |

## 🎯 方法选择

| Method | 速度 | 质量 | 适用场景 |
|--------|------|------|---------|
| `close_price` | ⚡⚡⚡ | ⭐ | 极速粗筛 |
| `weighted` | ⚡⚡ | ⭐⭐ | 快速筛选 |
| `enhanced_weighted` | ⚡ | ⭐⭐⭐⭐⭐ | **精确匹配（推荐）** |
| `dtw` | 🐌 | ⭐⭐⭐⭐ | 形态最精确但慢 |

## 📊 使用场景建议

### 场景1：少量候选 (< 100)
```python
method="enhanced_weighted"
use_prefilter=False  # 候选少，不需要预筛选
```

### 场景2：中等规模 (100-500)
```python
method="enhanced_weighted"
use_prefilter=True  # 🔥 建议开启预筛选
```

### 场景3：全市场扫描 (5000+)
```python
# 两阶段策略
# 阶段1：快速粗筛
method="weighted"  # 使用快速方法
use_prefilter=True

# 阶段2：对TOP100精筛
method="enhanced_weighted"
stock_codes=[top_100_codes]  # 只对TOP候选精筛
use_prefilter=False
```

## 💡 核心改进点

### enhanced_weighted 方法特点

1. **分段匹配**：前、中、后三段独立评分
2. **量价配合**：识别"放量上涨"vs"缩量上涨"
3. **量能倍数**：捕捉成交量暴增/萎缩
4. **绝对量级**：考虑涨幅的实际大小

### 能识别的模式
✅ 前段放量暴涨 + 中段缩量回调 + 后段放量企稳  
✅ 持续缩量阴跌  
✅ 放量突破后缩量回踩  
✅ 量价背离的假突破  

### 会过滤的误匹配
❌ 只是涨幅接近但无量能配合  
❌ 量价背离  
❌ 只有局部相似但整体不符  

## ⚙️ 性能提升预估（使用预筛选）

| 候选数 | 原耗时 | 使用预筛选后 | 加速比 |
|-------|-------|--------------|--------|
| 200 | 60秒 | 35秒 | 1.7x |
| 500 | 150秒 | 70秒 | 2.1x |
| 1000 | 300秒 | 130秒 | 2.3x |
| 5000 | 1500秒 | 650秒 | 2.3x |

*注：预筛选会过滤70%候选，实际效果取决于数据分布*

## 🧪 测试脚本

```bash
# 运行测试
conda activate trading
python tests/test_similar_trends_enhanced.py
```

## 📚 进一步优化建议

### 核心改进（已实现）
- ✅ **增强版相似度算法**：考虑量价配合、分段匹配、绝对量级
- ✅ **智能预筛选**：快速过滤70%不相关候选

### 使用建议
1. **优先使用 enhanced_weighted 方法**：准确识别量价配合模式
2. **候选数>100时开启预筛选**：显著减少计算量
3. **大规模场景采用两阶段策略**：先粗筛再精筛

### 注意事项
- ⚠️ **Windows多进程开销大**：数据序列化/反序列化比计算本身还慢，不建议使用
- 💡 **预筛选适用范围**：候选数量越多效果越明显 