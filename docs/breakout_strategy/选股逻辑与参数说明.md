# 突破策略选股逻辑与参数说明

## 核心理念

捕捉"波动性压缩后的放量突破"，通过两阶段筛选机制确保买点质量。
> 选股逻辑V1和V2版本一致。

---

## 🎯 选股流程

### 阶段1：初始突破信号（信号日）

**触发条件：**
1. 放量突破布林带上轨
2. 突破形态：
   - **标准突破**：收盘价 > 布林带上轨
   - **准突破**：最高价 > 上轨 且 收盘价 ≥ 上轨×97%（需补偿条件）

**多维度评分（总分6-11分）：**

#### 1. 环境分（0-3分）
- **盘整突破**：识别高位横盘形态 → B级(2分)
  - 条件：MA5与MA10高度贴合（偏离<2%），MA10斜率温和（5日涨幅<5%）
  - 参数：`consolidation_lookback=5`, `consolidation_ma_proximity_pct=0.02`, `consolidation_ma_max_slope=1.05`

- **动能突破**：根据价格距MA60的远近评分
  - A级(3分)：1.0 < 价格/MA60 ≤ 1.10（理想位置）
  - B级(2分)：1.10 < 价格/MA60 ≤ 1.25（趋势良好）
  - C级(1分)：1.25 < 价格/MA60 ≤ 1.45（追高）
  - D级(0分)：其他（超限）
  - 参数：`ma_macro_period=60`

#### 2. 压缩分（0-3分）
布林带宽度在60日历史区间的位置：
- A级(3分)：5% < 位置 ≤ 20%（极致压缩）
- B级(2分)：位置 ≤ 5%（超级压缩）
- C级(1分)：20% < 位置 ≤ 100%（普通）
- 参数：`bband_period=20`, `bband_devfactor=1.8`, `squeeze_period=60`

#### 3. 量能分（0-3分）
- **口袋支点识别**：成交量 > 近11日所有下跌日的最大量
  - A级(3分)：口袋支点 + 量比>2.5
  - B级(2分)：口袋支点 + 量比≤2.5
  - 参数：`pocket_pivot_lookback=11`

- **传统量比**：
  - A级(3分)：3.0 < 量比 ≤ 5.0
  - B级(2分)：1.5 < 量比 ≤ 3.0
  - C级(1分)：1.1 < 量比 ≤ 1.5
  - D级(0分)：量比 > 5.0（过高）或 ≤ 1.1（不足）
  - 参数：`volume_ma_period=22`

#### 4. 前高突破分（-1到+1分，可选）
相对80日前高的位置（排除最近5天）：
- 突破(+1分)：当前价 > 前高 + 4%
- 临界(0分)：前高-4% ≤ 当前价 ≤ 前高+4%
- 受阻(-1分)：当前价 < 前高 - 4%
- 参数：`enable_prior_high_score=True`, `prior_high_lookback=80`, `prior_high_exclude_recent=5`, `prior_high_upper_threshold=0.04`

**决策：**
- 总分 ≥ 6分：触发观察期（15天）
- 准突破必须有补偿：压缩分=3 或 量能分=3
- 参数：`observation_period=15`

---

### 阶段2：二次确认信号（观察期内）

在15天观察期内，等待以下任一信号：

#### 信号1：蓄势待发（高优先级）
平台整理后的突破启动：
1. 阳线 + 放量（量 > MA22）
2. 收盘价创近5日新高
3. 近5日收盘价均未破布林带中轨
4. 近5日最低价均未破布林带下轨

**买入后进入考察期（5天）：**
- 通过：最高价站上布林带上轨 → 切换为ATR止损
- 失败1：跌破中轨 → 清仓
- 失败2：5天未突破上轨 → 清仓

参数：`confirmation_lookback=5`, `probation_period=5`

#### 信号2：口袋支点（次优先级）
机构吸筹信号：
1. 价格在布林带中轨之上
2. 上涨日（收盘 > 前收盘）
3. 成交量 > 近11日所有下跌日的最大量

**买入后直接使用ATR止损**

参数：`pocket_pivot_lookback=11`

---

### 阶段3：三速档位系统（入场时机）

#### 快速通道（信号日当天）
**条件：**
- 初始突破评级 ≥ 6分
- MA5/MA10 > 1.03（前期强势）
- 收盘价在MA5的 -3% ~ +9% 区间内（回调到位）

**执行：** 信号日直接发出买入信号，跳过观察期

参数：`enable_fast_track=True`, `fast_track_ma5_ma10_ratio=1.03`, `optimal_entry_zone_lower=-0.03`, `optimal_entry_zone_upper=0.09`

#### 标准通道（观察期内）
**条件：**
- 不满足快速通道
- 二次确认信号出现
- 收盘价在 MA5-2% ~ MA5+8% 区间内

**执行：** 次日买入

参数：`optimal_entry_zone_lower=-0.02`, `optimal_entry_zone_upper=0.08`

#### 缓冲通道（等待回调）
**条件：**
- 二次确认信号出现
- 但收盘价 > MA5 + 9%（价格过高）

**执行：** 进入5天回踩等待期
- 出现回调（收盘 < 前收盘）且价格回到MA5±区间内 → 次日买入
- 出现回调但价格仍不在区间内 → 继续等待
- MA5掉头向下 → 放弃
- 5天超时 → 放弃

参数：`pullback_wait_period=5`, `optimal_entry_zone_lower=-0.03`, `optimal_entry_zone_upper=0.09`

---

### 🛡️ 最优买入区间（所有通道统一防线）

**核心概念：**
无论哪个通道触发买入，收盘价必须落在MA5的合理区间内，规避极端价格。

**区间定义：**
- 下限：MA5 × (1 - 3%) = MA5 × 0.97
- 上限：MA5 × (1 + 9%) = MA5 × 1.09

**适用范围：**
- ✅ 快速通道：信号日收盘价必须在区间内
- ✅ 标准通道：二次确认日收盘价必须在区间内
- ✅ 缓冲通道：回调后收盘价必须在区间内

**拒绝逻辑：**
- 价格过高（> 上限）→ 标准通道进入缓冲等待；快速通道放弃
- 价格过低（< 下限）→ 所有通道均拒绝买入

参数：`optimal_entry_zone_lower=-0.03`, `optimal_entry_zone_upper=0.09`

---

### 过滤器（观察期内）

#### 1. 价格窗口
- 上限：观察期高点 + 3.6×ATR
- 下限：观察期高点 × (1 - 9%)

参数：`atr_ceiling_multiplier=3.6`, `pullback_from_peak_pct=0.09`

#### 2. 过热分数
计算公式：`涨速 × (1 + 上影线×3)`
- 涨速 = max(日均涨速, 单日涨速) × 10
- 阈值：< 1.99（相当于单日20%涨幅）

参数：`overheat_threshold=1.99`

#### 3. VCP结构分（参考）
- 宏观环境分(35%)：价格位置 + MA斜率
- 波动压缩分(40%)：布林带宽度分位（非线性）
- 供给吸收分(25%)：缩量阳线 vs 放量阴线

参数：`vcp_lookback=60`, `vcp_macro_ma_period=90`, `vcp_absorption_lookback=20`

---

## 📊 图表标记说明

### 买入标记
- 绿色向上三角 ▲ - 所有通道的买入点（统一）

### 通道标记（K线上方）
- 金色向右三角 ▶ - 快速通道
- 浅蓝向右三角 ▶ - 回踩等待
- 绿色向右三角 ▶ - 回踩确认

### 信号标记（K线下方）
- 青色星形 ✱ - 蓄势待发
- 蓝色菱形 ◆ - 口袋支点
- 紫色五边形 ⬟ - 突破信号
- 橙色方形 ■ - 观察哨
- 红色五边形 ⬟ - 二次确认（扫描关注重点）

---

## 🛡️ 卖出逻辑

### ATR跟踪止损（主要）
- 入场首日：止损 = 收盘价 - 2.2×ATR
- 后续：止损 = 最高价 - 2.2×ATR（只上不下）
- 收盘价跌破止损 → 次日清仓

参数：`atr_period=14`, `atr_multiplier=2.2`

### 考察期止损（蓄势待发专用）
- 跌破中轨 → 清仓
- 5天未突破上轨 → 清仓

---

## 🎛️ 关键参数调节指南

### 提高选股数量
- ↓ `ma_macro_period` - 放宽环境要求（如60→50）
- ↓ `overheat_threshold` - 允许更快涨速（如1.99→2.5）
- ↑ `optimal_entry_zone_upper` - 接受更高价格（如8%→12%）

### 提高选股质量
- ↑ 总分阈值 - 要求更高评级（如6→7）
- ↓ `consolidation_ma_max_slope` - 更严格的盘整（如1.05→1.03）
- ↑ `volume_ma_period` - 更严格的放量（如22→30）

### 加快入场节奏
- ↓ `fast_track_ma5_ma10_ratio` - 更容易触发快速通道（如1.03→1.02）
- 关闭 `enable_fast_track=False` - 全部走观察期

### 降低追高风险
- ↓ `optimal_entry_zone_upper` - 更严格的价格上限（如8%→5%）
- ↑ `pullback_wait_period` - 更长的等待期（如5→7）

---

## 💡 使用建议

1. **日常扫描**：关注以下买入信号（均为最终买点）
   - "二次确认信号"（标准通道）- 红色五边形 ⬟
   - "快速通道"买入信号 - 金色向右三角 ▶
   - "回踩确认"买入信号 - 绿色向右三角 ▶

2. **扫描器配置**（`main.py`中的`strategy_scan`函数）：
   ```python
   signal_patterns = [
       '*** 二次确认信号',       # 标准通道
       '买入信号:【快速通道】',  # 快速通道
       '买入信号: 回踩确认',     # 缓冲通道
   ]
   ```

3. **评级参考**：A+级（8分+）> B级（6-7分）> C级（<6分不触发）

4. **图表分析**：
   - 看K线上方通道标记 → 了解入场类型
   - 看K线下方信号标记 → 了解确认形态
   - 看买入标记位置 → 确认实际成交价

5. **参数调优**：根据回测结果和市场环境，逐步调整关键参数 