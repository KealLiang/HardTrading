# Signal Scoring 配置文档

## 📊 评分系统概述

信号强度评分范围：**0-100分**

### 评分等级
- ⭐⭐⭐强：85+ 分
- ⭐⭐中：65-84 分
- ⭐弱：<65 分

---

## 🎯 评分维度（总分100+调整）

### 基础评分（100分）
1. **技术指标得分**（20分）：RSI/MACD/KDJ 超买超卖程度
2. **价格位置得分**（30分）：相对60根K线高低点的位置
3. **布林带偏离**（15分）：价格偏离布林带的程度
4. **量能形态+动量**（35分）：量价关系+拉升/下跌期判断

### 做T适用性调整（-55到+10）
5. **趋势惩罚**（0-30 扣分）：强趋势中逆向操作风险高
6. **波动率评估**（-10到+10）：波动适中时做T机会好
7. **横盘惩罚**（0-15 扣分）：价格变动小时的密集信号

---

## ⚙️ 可调参数配置

### 1. 评分阈值
```python
STRONG_THRESHOLD = 85      # 强信号阈值
MEDIUM_THRESHOLD = 65      # 中等信号阈值
```

### 2. 价格位置窗口
```python
POSITION_WINDOW = 60       # 判断价格位置的K线窗口
```

### 3. 动量判断
```python
MOMENTUM_WINDOW = 10       # 观察动量的K线窗口
MOMENTUM_THRESHOLD = 0.02  # 2%涨跌幅算快速拉升/下跌
MOMENTUM_PENALTY_MID = 0.45      # 拉升/下跌中途降级45%
MOMENTUM_PENALTY_EXTREME = 0.15  # 极端位置仅降级15%
```

### 4. 趋势惩罚参数
```python
TREND_WINDOW_SHORT = 30          # 短期趋势窗口（30分钟）
TREND_WINDOW_MID = 60            # 中期趋势窗口（60分钟）
TREND_STRONG_THRESHOLD = 0.06    # 强趋势阈值（6%）
TREND_MODERATE_THRESHOLD = 0.03  # 温和趋势阈值（3%）
```

**扣分规则**：
- **买入信号**：下跌趋势抄底风险
  - 强下跌（30/60根均-6%，65%K线下跌）：扣25分
  - 强下跌但有反弹：扣15分
  - 温和下跌（-3%到-6%，60%K线下跌）：扣12分
  - 温和下跌但有反弹：扣6分

- **卖出信号**：上涨趋势过早离场风险
  - 强上涨（30/60根均+6%，65%K线上涨）：扣20分
  - 强上涨但有回调：扣12分
  - 温和上涨（+3%到+6%，60%K线上涨）：扣10分
  - 温和上涨但有回调：扣5分

### 5. 横盘密集信号惩罚参数（v1.2新增）
```python
CONSOLIDATION_WINDOW = 10                # 横盘检测窗口（10根K线）
CONSOLIDATION_RANGE_EXTREME = 0.01      # 极窄幅横盘（1%）
CONSOLIDATION_RANGE_NARROW = 0.015      # 窄幅横盘（1.5%）
CONSOLIDATION_RANGE_MILD = 0.025        # 轻微横盘（2.5%）
CONSOLIDATION_DIRECTION_THRESHOLD = 0.3 # 方向一致性阈值（30%）
```

**扣分规则**：
- 极窄幅横盘（波动<1% + 无方向）：扣15分
- 窄幅横盘（波动1%-1.5% + 无方向）：扣10分
- 轻微横盘（波动1.5%-2.5% + 无方向）：扣5分

**横盘判断逻辑**：
```python
price_range = (max - min) / mean        # 价格波动幅度
direction_consistency = |总变化| / Σ|变化|  # 方向一致性
is_consolidating = (price_range < 1.5% AND direction_consistency < 30%)
```

### 6. 波动率评估（加/扣分）
```python
# 波动率范围
volatility = std / mean  # 20根K线的标准差/均值

# 偏离度
deviation = |current - ma20| / ma20
```

**加/扣分规则**：
- 偏离3%以上 + 波动1%-4%：+8分（理想做T环境）
- 偏离2%以上 + 波动1%-5%：+5分
- 波动<0.8%：-8分（太小，无做T空间）
- 波动>6%：-5分（太大，风险高）

---

## 📈 技术指标评分规则

### RSI 评分（0-20分）
**买入信号**：
- RSI < 15：20分
- RSI < 20：14分
- RSI < 25：8分
- RSI < 30：3分

**卖出信号**：
- RSI > 85：20分
- RSI > 80：14分
- RSI > 75：8分
- RSI > 70：3分

### 价格位置评分（0-30分）
**买入信号**：
- 位置 < 8%：30分（极低位）
- 位置 < 15%：20分
- 位置 < 25%：10分
- 位置 < 35%：3分
- 位置 ≥ 35%：-10分（高位抄底）

**卖出信号**：
- 位置 > 96%：30分（极高位）
- 位置 > 92%：22分
- 位置 > 85%：15分
- 位置 > 75%：8分
- 位置 > 65%：3分
- 位置 ≤ 65%：-10分（半山腰）

### 布林带偏离（0-15分）
**买入信号**：
- 跌破下轨 > 1.5%：15分
- 跌破下轨 > 0.8%：10分
- 触及下轨：5分

**卖出信号**：
- 突破上轨 > 1.5%：15分
- 突破上轨 > 0.8%：10分
- 触及上轨：5分

### 量能形态（0-35分）
**买入信号**：
- 极低位（<4%）+ 巨量（>2.5x）+ 非下跌期：35分（恐慌盘出尽）
- 低位（<15%）+ 温和放量（1.2-2x）+ 非下跌期：30分（企稳反弹）
- 极低位（<10%）+ 缩量（<0.5x）：28分（缩量见底）

**卖出信号**：
- 极高位（>96%）+ 巨量（>3x）+ 非拉升期：35分
- 高位（>85%）+ 温和放量（1.3-2.5x）+ 非拉升期：30分
- 高位（>85%）+ 缩量（<1.3x）：28分（量价背离）

---

## 🛠️ 参数调整建议

### 想要更严格过滤（减少信号）
1. 提高最低分数阈值：`MIN_SIGNAL_SCORE = 65`
2. 加大趋势惩罚：`TREND_STRONG_THRESHOLD = 0.05`（5%即判定强趋势）
3. 加大横盘惩罚：`CONSOLIDATION_PENALTY_EXTREME = 20`

### 想要更宽松（增加信号）
1. 降低最低分数阈值：`MIN_SIGNAL_SCORE = 45`
2. 减小趋势惩罚：`TREND_STRONG_THRESHOLD = 0.08`（8%才判定强趋势）
3. 减小横盘惩罚：`CONSOLIDATION_PENALTY_EXTREME = 10`

### 针对高波动股票
1. 提高波动率阈值：修改 `_calc_volatility_bonus` 中的 `0.06` → `0.08`
2. 放宽横盘判断：`CONSOLIDATION_RANGE_NARROW = 0.02`（2%）

### 针对低波动股票
1. 降低波动率要求：修改 `_calc_volatility_bonus` 中的 `0.008` → `0.005`
2. 收紧横盘判断：`CONSOLIDATION_RANGE_EXTREME = 0.005`（0.5%）

---

## 💡 使用示例

### 修改参数
```python
# alerting/signal_scoring.py 第40-67行

class SignalScorer:
    # 修改评分阈值
    STRONG_THRESHOLD = 85      # 可改为80（更宽松）或90（更严格）
    MEDIUM_THRESHOLD = 65      # 可改为60或70
    
    # 修改趋势惩罚
    TREND_STRONG_THRESHOLD = 0.06   # 可改为0.05或0.08
    
    # 修改横盘惩罚
    CONSOLIDATION_PENALTY_EXTREME = 15  # 可改为10或20
```

### 配合最低分数阈值使用
```python
# alerting/t_trade_alert_v3.py 第73行

MIN_SIGNAL_SCORE = 55  # 0=不过滤，55=过滤弱信号，65=只保留中强信号
```

---

## 📊 典型评分示例

### 高质量买入信号（90分）
- RSI 15（20分）
- 价格位置 5%（30分）
- 跌破下轨 2%（15分）
- 极低位巨量（35分）
- 震荡行情（0扣分）
- 波动适中（-10分）
- **总分：90分 ⭐⭐⭐强**

### 下跌趋势低质量信号（40分）
- RSI 25（8分）
- 价格位置 25%（10分）
- 触及下轨（5分）
- 温和放量（12分）
- **强下跌趋势（-25分）**← 关键扣分
- 波动适中（+5分）
- 横盘（-10分）← 密集信号扣分
- **总分：40分 ⭐弱（被过滤）**

---

## 🔄 版本历史

- **v1.0**：基础评分系统
- **v1.1**：新增趋势惩罚 + 波动率评估
- **v1.2**：新增横盘密集信号惩罚（参数可配置） 