# 候选股历史追踪和回顾功能

## 功能概述

该功能自动记录每次扫描的候选股票，并支持回顾分析历史候选股的后续走势。

## 核心功能

### 1. 自动记录功能
- **功能**: 每次执行扫描时，自动将候选股记录到历史文件
- **记录策略**: **只记录扫描范围最后一日的候选股**
  - 扫描是以某个日期为截止日期，只有那一天的信号是准确的
  - 其他日期的信号只是附带的，不作为候选股记录
  - 例如：扫描范围 2025-07-30 to 2025-10-24，只记录 10-24 的信号
- **文件位置**: `bin/candidate_history/selection_history.txt`
- **记录内容**: 执行时间、信号日期、模式、股票代码、股票名称、信号价格、评分、详情
- **触发方式**: 已集成到 `full_scan_routine()` 中，自动执行

### 2. 历史回顾功能
- **功能**: 读取历史记录，生成包含后续走势的对比图
- **图表特点**:
  - 显示入选日期前X天的K线（默认90天，可配置）
  - 显示入选日期到最近交易日的完整走势
  - 标注入选点位（K线下方）
  - 计算并显示收益率
  - 2列布局，便于对比
  - 红涨绿跌（A股习惯）
- **模式标记**:
  - 🔵 蓝色圆形 `○`: 止跌反弹策略A
  - 🟣 紫色五角星 `⬟`: 突破策略A
  - 🟠 橙色方形 `□`: 突破策略B

## 使用方法

### 日常扫描（自动记录）

```python
# 在 main.py 中执行
full_scan_routine('a')
```

执行后会自动：
1. 扫描突破策略和止跌反弹策略
2. 生成对比图
3. **自动记录候选股到历史文件** ✨

### 回顾历史候选股

```python
# 在 main.py 中执行

# 示例1: 回顾10-20到10-24所有模式的候选股
review_history('2025-10-20', '2025-10-24')

# 示例2: 只回顾止跌反弹策略a的候选股
review_history('2025-10-20', '2025-10-24', model='rebound_a')

# 示例3: 回顾突破策略a的候选股，显示前60天
review_history('2025-10-20', '2025-10-24', model='breakout_a', before_days=60)

# 示例4: 支持YYYYMMDD格式
review_history('20251020', '20251024')
```

### 参数说明

**review_history()参数**:
- `start_date`: 开始日期（信号日期），格式 'YYYY-MM-DD' 或 'YYYYMMDD'
- `end_date`: 结束日期（信号日期），格式 'YYYY-MM-DD' 或 'YYYYMMDD'
- `model`: 模式筛选（可选）
  - `None`: 全部模式
  - `'rebound_a'`: 止跌反弹策略a
  - `'breakout_a'`: 突破策略a
  - `'breakout_b'`: 突破策略b
- `before_days`: 入选日期之前显示的天数（默认90天）

### 输出位置

- **历史记录文件**: `bin/candidate_history/selection_history.txt`
- **回顾对比图**: `bin/candidate_history/review_charts/review_comparison_YYYYMMDD.png`

## 文件格式

### selection_history.txt 格式

```
执行时间|信号日期|模式|股票代码|股票名称|信号价格|评分|详情
2025-10-25 10:30:00|2025-10-24|rebound_a|000969|安泰科技|12.50|0|*** 止跌反弹买入信号触发 @ 12.50 ***...
2025-10-25 10:30:00|2025-10-24|breakout_a|600172|黄河旋风|8.30|8|*** 二次确认信号已触发 @ 8.30 ***...
```

## 典型使用场景

### 场景1: 日常盘后扫描
```python
# 每天收盘后执行
full_scan_routine('a')

# 自动完成：
# 1. 扫描今日候选股
# 2. 生成对比图
# 3. 记录到历史文件
```

### 场景2: 周末回顾本周入选股
```python
# 周末执行，查看本周候选股的走势
review_history('2025-10-21', '2025-10-25')
```

### 场景3: 分析特定策略效果
```python
# 只看止跌反弹策略a的效果
review_history('2025-10-01', '2025-10-25', model='rebound_a')
```

### 场景4: 复盘某个时期
```python
# 回顾9月份的所有候选股表现
review_history('2025-09-01', '2025-09-30')
```

## 注意事项

1. **历史文件是累积的**: 不会删除旧记录，可长期追踪
2. **不要手动删除历史文件**: 删除后需要重新积累数据
3. **回顾功能需要股票数据**: 确保 `data/astocks` 目录有最新数据
4. **首次使用**: 第一次执行扫描时会自动创建历史文件

## 技术实现

- **记录模块**: `bin/selection_history_tracker.py`
- **回顾模块**: `bin/selection_review_visualizer.py`
- **集成入口**: `main.py` 中的 `full_scan_routine()` 和 `review_history()`

## 故障排查

### 问题1: 历史文件为空
**原因**: 第一次使用或尚未执行过扫描
**解决**: 执行一次 `full_scan_routine('a')`

### 问题2: 回顾图未生成
**原因**: 指定日期范围内没有记录，或股票数据缺失
**解决**: 
- 检查历史文件是否有对应日期的记录
- 确认股票数据文件完整性

### 问题3: 收益率显示异常
**原因**: 股票数据未更新到最新
**解决**: 更新股票数据后重新生成回顾图 