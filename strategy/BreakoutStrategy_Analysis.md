# BreakoutStrategy 深度解析

## 1. 策略概述

`BreakoutStrategy` 是一个用于A股市场的多维度、分阶段的**波动性压缩突破**交易策略。其核心思想并非简单地执行买卖，而是通过一套复杂的评分和观察机制，识别高质量的交易机会，并生成详尽的日志用于投研分析。

### 核心哲学
- **信号质量优先于数量**: 策略通过严格的评级和过滤，力求捕捉高概率的突破形态，而非盲目交易所有信号。
- **两阶段执行**: 策略将交易过程分为**“初始信号识别”**和**“二次确认入场”**两个阶段，通过引入“观察哨”模式，有效过滤了大量的假突破。
- **多维度评估**: 策略从宏观环境、波动状态、量能强度、K线形态等多个维度对市场进行综合评估，体现了系统化的交易思想。

### 关键特性
1.  **信号评级系统**: 对初始突破信号进行打分，只有达到一定评级的信号才能触发后续的“观察哨”模式。
2.  **观察哨模式 (Observation Mode)**: 在识别出高质量的初始信号后，策略并不立即入场，而是进入一个预设的观察期，等待更明确的二次确认信号。
3.  **双重二次确认信号**: 在观察期内，策略会寻找两种高确定性的入场形态：**"蓄势待发 (Coiled Spring)"** 和 **"口袋支点 (Pocket Pivot)"**。
4.  **动态风险管理**: 结合了常规的 ATR 跟踪止损和针对特定信号的特殊止损逻辑（如“考察期”机制）。
5.  **高级分析模块 (PSQ & VCP)**: 内置了两套复杂的数据分析和评分系统，用于在信号触发后持续评估价格行为的质量，并为最终的复盘分析提供数据支持。

---

## 2. 核心工作流程

策略的执行流程可以分解为以下四个主要阶段：

[点击查看策略工作流程图 (HTML)](./workflow_diagram.html)

1.  **初始信号识别与评级 (Initial Signal Identification)**
    - **触发条件**: 当日放量（成交量 > `volume_ma`），并且价格满足**严格突破**（收盘价 > 布林带上轨）或**准突破**（最高价 > 上轨，且收盘价在距上轨 `breakout_proximity_pct` 范围内）。
    - **信号评级**: 对满足条件的 K 线进行三维度评分：
        - `环境分`: 优先识别高质量的**短期盘整后突破**形态；否则，根据当前价格与长期均线（`ma_macro`）的距离进行评分，避免追高。
        - `压缩分`: 基于当前布林带宽度（BBW）在过去 `squeeze_period` 内的百分比位置进行评分，奖励极端压缩的状态。
        - `量能分`: 结合成交量与均量的比率，并引入**“口袋支点”**的逻辑（当日成交量超过近期所有下跌日的成交量），对高质量的放量进行加分。
    - **决策**: 只有总分达到阈值（默认为6分）的信号，才能触发下一阶段。

2.  **"观察哨"模式 (Observation Sentry Mode)**
    - 触发后，策略进入为期 `observation_period` 天的观察期。
    - 在此期间，策略会持续跟踪价格走势，并计算每日的 **PSQ (Post-Signal Quality)** 分数。
    - 主要目标是寻找高确定性的二次确认入场信号。

3.  **二次确认与入场 (Secondary Confirmation & Entry)**
    - 在观察期内，策略会应用一系列过滤器来规避风险，包括：
        - **动态价格接受窗口**: 防止在离观察期高点过远或回撤过深时入场。
        - **过热分过滤器**: 通过 PSQ 系统计算一个“过热分”，如果分数过高，则拒绝信号。
    - 如果通过所有过滤器，策略将寻找以下两种信号之一进行入场：
        - **"蓄势待发 (Coiled Spring)" (优先)**: 形态要求在 `confirmation_lookback` 周期内，K线在布林带中轨之上进行窄幅整理，然后放量突破近期高点。这是一个强烈的趋势启动信号。
        - **"口袋支点 (Pocket Pivot)"**: 当日收盘价在中轨之上，且成交量能够“吸收”掉近期所有下跌日的抛压。这是一个识别机构吸筹的有效信号。

4.  **持仓管理与退出 (Position Management & Exit)**
    - **常规退出**: 对于普通突破和通过考察期的仓位，使用标准的 **ATR 跟踪止损**。止损位会随着价格新高而上移，但绝不下降。
    - **特殊退出 ("考察期")**: 对于通过 "蓄势待发" 信号买入的仓位，会进入一个为期 `probation_period` 天的特殊考察期。
        - **考察成功**: 如果期间价格突破布林带上轨，则考察期结束，转为常规 ATR 止损。
        - **考察失败**: 如果价格跌破布林带**中轨**，或考察期结束仍未突破上轨，则**立即清仓**。这个机制确保了策略只持有最具爆发力的仓位。

---

## 3. 高级分析模块

策略内置了两个核心的分析系统，VCP 和 PSQ，它们是策略实现智能化评估的关键。

### VCP "中庸之道" 评分系统

- **目的**: 在二次确认信号出现时，为当前的市场结构提供一个参考性的**“健康度”**评分。它不直接参与决策，但其输出的日志对于人工分析极具价值。
- **核心思想**: “过犹不及”。评分系统认为无论是宏观趋势、波动性还是价格位置，都存在一个“最优”的平衡点，过高或过低都会导致分数下降。
- **评估维度**:
    1.  **宏观环境分 (Macro Score)**: 结合了价格与长期均线（`vcp_macro_ma`）的**相对位置**和长期均线自身的**斜率 (ROC)**。价格过高或趋势过快（可能过热）都会被扣分。
    2.  **波动状态分 (Squeeze Score)**: 使用布林带宽度在过去 `vcp_lookback` 周期内的**百分比排名 (PctRank)** 来量化波动性压缩程度。压缩越剧烈（百分比排名越低），得分越高。
    3.  **供给吸收分 (Absorption Score)**: 分析在前期高点（供给区）附近的价格行为。在供给区内，**缩量收阳**被视为有效吸收，会加分；而**放量收阴**则被视为抛压沉重，会减分。
- **最终得分**: 将三个维度的得分进行加权平均，得出一个0-100的总分，并将其映射为 `VCP-A+` 到 `VCP-F` 的评级。

### PSQ (Post-Signal Quality) 评分系统

- **目的**: 在初始信号触发**之后**，每日量化价格行为的质量。它用于动态评估趋势的健康度，并为**过热过滤器**提供数据支持。
- **应用场景**: 分别在“观察期”和“持仓期”启用，其统计结果（盈利交易和亏损交易的PSQ分数分布）是优化策略参数的重要依据。
- **评估维度**:
    1.  **形态分 (Pattern Score)**: 结合近期趋势（上涨/下跌），利用 TA-Lib 识别关键的K线反转形态（如吞没、乌云盖顶、早晨之星等），并给予-3到+3的强弱分值。
    2.  **动能分 (Momentum Score)**:
        - **日内力量 (Intraday Power)**: 综合评估K线实体比例、上下影线，并结合其在近期高低点通道内的**相对位置**来计算。例如，在通道低位的长下影线是强支撑信号，得分会更高。
        - **量能强度 (Volume Strength)**: 当日成交量与均量的比值。
    3.  **过热分 (Overheat Score) (仅观察期)**:
        - 核心是**涨速指标 (Velocity Metric)**，综合考虑了“信号日以来的日均涨幅”和“当日涨幅”，取其最大值。
        - 如果当日出现**上影线**，则认为上涨伴随着犹豫和抛压，会**放大**涨速指标，从而提高过热分。这个分数是 `overheat_threshold` 过滤器的决策依据。
- **最终得分**: 形态分和动能分根据预设权重 (`psq_pattern_weight`, `psq_momentum_weight`) 加总，得到当日的PSQ分数。

---

## 4. 关键参数解读

策略的 `params` 部分定义了其所有可调参数，理解它们是优化和使用策略的基础。为了清晰，此处按功能模块进行分类。

#### 4.1 核心指标与信号识别
- **布林带相关**:
    - `bband_period`, `bband_devfactor`: 布林带的周期和标准差，定义了策略的“轨道”。
- **成交量**:
    - `volume_ma_period`: 成交量均线周期，用于判断“放量”。
- **宏观环境**:
    - `ma_macro_period`: 定义宏观环境的长周期均线，用于初步的环境评分。
- **突破形态**:
    - `consolidation_lookback`, `consolidation_ma_proximity_pct`, `consolidation_ma_max_slope`: 用于识别“短期盘整”形态的三个关键参数，分别定义了回看期、均线贴合紧密度和均线最大斜率。
    - `breakout_proximity_pct`: 定义了“准突破”时，收盘价可以低于上轨的最大容忍百分比。
- **波动性压缩**:
    - `squeeze_period`: 计算压缩分的回看周期。

#### 4.2 观察期与二次确认
- `observation_period`: “观察哨”模式的持续天数。
- `confirmation_lookback`: “蓄势待发”信号的回看周期。
- `pocket_pivot_lookback`: “口袋支点”信号的回看周期。

#### 4.3 风险管理与过滤器
- **ATR 止损**:
    - `atr_period`, `atr_multiplier`: ATR 跟踪止损的周期和乘数。
- **特殊考察期**:
    - `probation_period`: “蓄势待发”买入后的考察期天数。
- **价格窗口过滤器**:
    - `pullback_from_peak_pct`: 价格过滤器，定义了从观察期高点可接受的最大回撤。
    - `atr_ceiling_multiplier`: 价格过滤器，定义了价格距离观察期高点的最大ATR倍数，防止追高。
- **过热过滤器**:
    - `overheat_threshold`: PSQ 过热分数的阈值，超过此值将拒绝入场。
- **仓位管理**:
    - `initial_stake_pct`: 初始开仓资金占总资产的百分比。

#### 4.4 PSQ 评分系统
- `context_period`: PSQ 动能分中，用于定位价格在近期高低点通道位置的回看周期。
- `psq_pattern_weight`, `psq_momentum_weight`: PSQ 系统中，形态分和动能分的权重。
- `psq_summary_period`: 在最终回测报告中，用于计算持仓期初期 N 日平均 PSQ 的天数。

#### 4.5 VCP 评分系统
- **核心参数**:
    - `vcp_lookback`: VCP 波动率计算的总回看期。
    - `vcp_macro_ma_period`: VCP 宏观环境判断的均线周期。
    - `vcp_absorption_lookback`, `vcp_absorption_zone_pct`: VCP 供给吸收分析的回看期和供给区范围定义。
- **"中庸之道"平衡参数**:
    - `vcp_macro_roc_period`: 计算宏观 MA 斜率的回看期。
    - `vcp_optimal_ma_roc`, `vcp_max_ma_roc`: 宏观 MA 的最优斜率和斜率上限。
    - `vcp_optimal_price_pos`, `vcp_max_price_pos`: 价格与 MA 的最优位置和位置上限。
    - `vcp_squeeze_exponent`: 波动压缩分的非线性指数，用于放大极端压缩的效果。
- **权重**:
    - `vcp_weight_macro`, `vcp_weight_squeeze`, `vcp_weight_absorption`: VCP 三大模块的最终得分权重。

---

## 5. 如何使用与回测

- **入口文件**: `bin/simulator.py` 是运行该策略进行回测的主要入口。
- **开启调试日志**: 在 `simulator.py` 中，为 `BreakoutStrategy` 设置 `strategy_params={'debug': True}`。这将激活策略中所有详细的日志输出，包括每日的信号评级计算、VCP分析和PSQ分数构成，对于理解策略行为和调试至关重要。
- **结果分析**: 回测结束后，如果设置了 `log_trades=True`，会在 `strategy/post_analysis` 目录下生成包含详细日志和图表的文件夹。特别地，当 `debug=True` 时，控制台会输出一份**PSQ特征分析报告**，该报告会统计盈利、亏损和平庸交易在不同阶段的PSQ分数均值，是判断当前参数是否有效的关键依据。

通过分析这份报告，可以洞察：
- 盈利交易是否普遍具有更高的PSQ分数？
- 亏损交易是否在入场前或持仓初期就表现出较低的PSQ分数？
- 这些问题的答案将直接指导下一步的参数优化方向。

---

## 6. 附录：核心算法详解

本部分详细拆解策略中几个关键模块的算法实现。

### 6.1 初始信号评级算法

当一个“放量突破”K线出现时，策略通过以下三个维度计算总分（满分9分）：

1.  **环境分 (Environment Score, 满分3分)**
    - **路径一 (优先)**: 首先检查是否满足 `_check_short_term_consolidation()` 定义的**短期盘整**形态。
        - **条件**: 在 `consolidation_lookback` 周期内，5日线和10日线持续贴近 (距离 < `consolidation_ma_proximity_pct`)，且10日线斜率平缓 (涨幅 < `consolidation_ma_max_slope`)。
        - **评分**: 如果满足，直接评为 **B级 (2分)**，认可其形态价值。
    - **路径二**: 如果不是盘整突破，则根据收盘价 `C` 与 `ma_macro_period` 周期均线 `MA` 的比率 `Ratio = C / MA` 来评分：
        - `1.0 < Ratio <= 1.10`: **A级 (3分)**，理想启动区。
        - `1.10 < Ratio <= 1.25`: **B级 (2分)**，趋势加速区。
        - `1.25 < Ratio <= 1.45`: **C级 (1分)**，有追高风险。
        - `其他`: **D级 (0分)**，过高或处于均线之下。

2.  **压缩分 (Squeeze Score, 满分3分)**
    - 计算当前布林带宽度 `BBW` 在过去 `squeeze_period` 周期内的百分位 `SqueezePct`。
    - `0.05 < SqueezePct <= 0.20`: **A级 (3分)**，波动率处于极度压缩后的激活状态。
    - `SqueezePct <= 0.05`: **B级 (2分)**，波动率极度压缩，但可能尚未激活。
    - `0.20 < SqueezePct <= 1.00`: **C级 (1分)**，压缩不充分。
    - `其他`: **D级 (0分)**。

3.  **量能分 (Volume Score, 满分3分)**
    - **优先判断**: 首先检查是否满足**“口袋支点”**量能特征。
        - **条件**: 当日成交量 `V` > 过去 `pocket_pivot_lookback` 周期内**所有下跌日**的最高成交量。
        - **评分**: 如果满足，则：
            - 若 `V / volume_ma > 2.5`: **A级 (口袋支点+, 3分)**。
            - 否则: **B级 (口袋支点, 2分)**。
    - **常规判断**: 如果不满足口袋支点，则根据成交量比率 `VolumeRatio = V / volume_ma` 评分：
        - `3.0 < VolumeRatio <= 5.0`: **A级 (3分)**，理想放量。
        - `1.5 < VolumeRatio <= 3.0`: **B级 (2分)**，优秀放量。
        - `1.1 < VolumeRatio <= 1.5`: **C级 (1分)**，合格放量。
        - `其他`: **D级 (0分)**，量能过大或过小。

### 6.2 二次确认信号算法

#### "蓄势待发" (Coiled Spring)
- **条件1**: 当日必须是**阳线**且**放量** (`Volume > volume_ma`)。
- **条件2**: 当日收盘价创下过去 `confirmation_lookback` 周期内的**收盘价新高**。
- **条件3**: 在过去 `confirmation_lookback` 周期内，每日的**收盘价都必须在布林带中轨之上**。
- **条件4**: 在过去 `confirmation_lookback` 周期内，每日的**最低价都必须在布林带下轨之上**。

#### "口袋支点" (Pocket Pivot)
- **条件1**: 当日收盘价必须在布林带**中轨之上**，表明处于短期强势。
- **条件2**: 当日必须是**上涨日** (收盘价 > 昨日收盘价)。
- **条件3**: 当日成交量必须**大于**过去 `pocket_pivot_lookback` 周期内所有**下跌日**的成交量最大值。

### 6.3 VCP 评分算法

VCP 评分是一个 0-100 分的加权系统，核心是 `_get_balanced_score` 平衡函数，它使得各项指标在“最优值”附近得分最高，过高或过低都会衰减。

1.  **宏观环境分 (权重 `vcp_weight_macro`)**
    - **价格位置分**: 基于 `收盘价 / vcp_macro_ma` 计算，最优值在 `vcp_optimal_price_pos` (如1.05)，上限为 `vcp_max_price_pos`。
    - **趋势斜率分**: 基于 `vcp_macro_ma` 在 `vcp_macro_roc_period` 周期内的变化率计算，最优值在 `vcp_optimal_ma_roc` (如1.03)，上限为 `vcp_max_ma_roc`。
    - 两者各占50%权重，合成宏观分。

2.  **波动状态分 (权重 `vcp_weight_squeeze`)**
    - 基于布林带宽度在过去 `vcp_lookback` 周期内的**百分比排名 `BBW_PctRank`** (0.0-1.0)。
    - 分数 = `((1.0 - BBW_PctRank) ** vcp_squeeze_exponent) * 100`。指数 `vcp_squeeze_exponent` (如1.5) 用来非线性地奖励极端压缩。

3.  **供给吸收分 (权重 `vcp_weight_absorption`)**
    - 在信号日前 `vcp_absorption_lookback` 周期内，找到价格高点 `HWM`。
    - 定义 `HWM` 下方 `vcp_absorption_zone_pct` 范围为“供给区”。
    - 遍历供给区内的每一天，根据其**收盘价在K线中的位置**和**成交量比率**给出一个事件分（-2 到 +2）。
        - 缩量收阳得分高 (如+2)。
        - 放量收阴扣分多 (如-2)。
    - 将所有事件分平均后，映射到 0-100 的范围作为最终得分。

### 6.4 PSQ 评分算法

PSQ 总分由形态分和动能分加权构成。

1.  **形态分 (Pattern Score, 权重 `psq_pattern_weight`)**
    - 基于 TA-Lib 识别的K线形态，并结合前两日的简单趋势进行评分：
        - **近期上涨趋势下**:
            - 强看跌形态 (黄昏星, 阴吞噬): **-3.0**
            - 中看跌形态 (乌云盖顶, 孕线, 射击之星): **-2.0**
            - 弱看跌形态 (十字星): **-1.0**
        - **近期下跌趋势下**:
            - 强看涨形态 (启明星, 阳吞噬): **+3.0**
            - 中看涨形态 (刺透, 孕线, 锤子线): **+2.0**
            - 弱看涨形态 (十字星): **+1.0**

2.  **动能分 (Momentum Score, 权重 `psq_momentum_weight`)**
    - **日内力量 (Intraday Power)**:
        - `Power = (实体比例 * 2.0) + (下影线比例 * (2.0 * (1 - 价格通道位置))) - (上影线比例 * (1.0 + 价格通道位置))`
        - **价格通道位置**: 当前收盘价在过去 `context_period` 周期高低点通道内的百分比位置 (0.0-1.0)。
        - 这个公式动态地调整了影线的权重：在通道低位的长下影线（支撑）权重更高，在高位的长上影线（阻力）惩罚更重。
    - **量能强度 (Volume Strength)**: `(当日成交量 / volume_ma) - 1`。
    - **动能分 = 日内力量 + 量能强度**。

3.  **过热分 (Overheat Score, 仅在观察期计算)**
    - **涨速指标 (Velocity Metric)**: `max(日均涨幅, 当日涨幅) * 10`。
        - *日均涨幅*: `(当前收盘价 - 信号日收盘价) / 信号日收盘价 / 间隔天数`。
    - **最终过热分**: `Velocity_Metric * (1 + 上影线比例 * 3)`。
    - 如果当日存在显著上影线，过热分会被急剧放大，从而更容易触发过滤器。
---

## 7. 策略迭代V2方案 (修订版)：融合VCP与PSQ实现动态仓位管理

本方案旨在将VCP与PSQ评分系统深度融合到交易决策中，核心目标是**根据信号质量和趋势健康度，动态调整风险敞口**，将策略升级为自适应的交易系统。本次修订根据专业交易的客观性原则，剔除了主观参数，并强化了决策逻辑的鲁棒性。

### 7.1 VCP评分：动态决定初始仓位 (逻辑不变)

VCP评分作为对二次确认信号出现时市场结构的“健康度”评估，是决定初始投入信心的绝佳量化指标。

- **核心逻辑**：将开仓仓位与VCP分数线性挂钩，VCP分数越高，初始仓位越重。仓位范围控制在`20% ~ 80%`的总计划仓位之间。
- **实现方案**:
    1.  新增参数 `vcp_min_stake_pct` (值为 0.2) 和 `vcp_max_stake_pct` (值为 0.8)。
    2.  当二次确认信号触发时，计算出 VCP 分数 `vcp_score` (范围 0-5)。
    3.  通过以下公式计算实际的初始仓位百分比 `actual_stake_pct`:
        ```
        scaling_factor = vcp_score / 5.0  // VCP分数归一化
        actual_stake_pct = vcp_min_stake_pct + (vcp_max_stake_pct - vcp_min_stake_pct) * scaling_factor
        ```
    4.  最终的初始仓位 = `总资金 * initial_stake_pct * actual_stake_pct`。
- **优点**：
    - **风险匹配**：使得风险敞口与信号的确定性相匹配，在高质量信号时放大潜在回报。
    - **保留机会**：对于结构一般的信号（VCP低分），以较小仓位试探，避免了“一刀切”过滤可能错失的机会。
    - **预留资金**：为后续基于PSQ的动态加仓提供了资金储备。

### 7.2 PSQ评分：动态调整持仓 (加仓与减仓)

PSQ评分每日量化持仓期间价格行为的质量，是实现动态加仓和减仓的决策依据。**为了保证策略的鲁棒性，V2版本将专注于“加仓”和“止盈”这两个核心操作，暂时移除容易引入错误的“做T”逻辑。**

#### 7.2.1 动态加仓 (Pyramiding)

- **核心逻辑**：当初始仓位并非满仓时，若趋势维持健康，则在建设性的回调企稳后进行加仓，以求在正确的头寸上扩大战果。
- **触发条件 (必须同时满足)**:
    1.  **仓位空间**：当前仓位 < 100% 计划总仓位 (`initial_stake_pct`)。
    2.  **趋势健康 (Trend Health Filter)**：
        - 价格维持在短期趋势均线之上 (例如 `close > ma10`)。
        - 短期攻击形态保持 (例如 `ma5 > ma10`)。
    3.  **建设性回调 (Constructive Pullback)**：
        - 价格从持仓期高点回撤一定深度，提供安全边际 (例如 `pullback > add_on_pullback_atr * ATR`)。
    4.  **动能企稳 (Momentum Confirmation)**：
        - 近期PSQ均分维持在健康水平 (例如 `last_3_days_psq_avg > psq_add_on_threshold`)。
        - 当日出现企稳信号 (当日 `psq_score > 0`)。
- **执行操作**：
    - 加仓 `X%` 的初始仓位（例如 25%），总仓位不超过 `initial_stake_pct`。

#### 7.2.2 减仓/止盈 (Profit Taking) - 逻辑不变

- **核心逻辑**：利用PSQ分数识别趋势的短期“高潮”或“力竭”点，主动锁定部分利润，改善盈利质量。
- **触发条件**:
    1.  仓位已产生显著浮盈 (例如 > `min_profit_for_taking`)。
    2.  PSQ分数超过 `psq_profit_taking_score` (例如 +6.0)，表明当日出现极端上涨，可能伴随情绪过热。
- **执行操作**：
    - 主动卖出 `Y%` 的当前仓位（例如 30%）。
    - 剩余仓位继续由ATR跟踪止损管理。

### 7.3 方案总结与自我修正机制

本次V2方案升级的核心，是将**静态规则**与**动态评估**相结合，形成一个完整的交易闭环。

[点击查看策略工作流程图V2 (HTML)](./workflow_diagram_v2.html)

- **自我修正机制**:
    - **高层决策**：VCP和PSQ的动态管理属于策略的高层决策，它们负责在趋势健康时“踩油门”（加仓），在可能过热时“点刹车”（止盈）。
    - **底层风控**: **ATR跟踪止损是策略最终、也是最核心的自我修正和风险控制机制**。无论高层决策如何判断，一旦价格行为恶化并触及这条“生命线”，必须无条件退出。这道防线确保了策略即使在高层决策中出现失误（例如在错误的位置加仓），也能将单笔亏损控制在可接受的范围内，防止灾难性损失。
- **风险提示**：
    - 方案依然引入了更多待优化的参数，增加了模型的复杂度和过拟合的风险。
    - 所有新增逻辑必须通过充分的回测来验证其在不同市场环境下的有效性。 